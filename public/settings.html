<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp AI Settings Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }
      .navbar-brand {
        font-weight: 600;
      }
      .status-connected {
        color: #198754;
      }
      .status-disconnected {
        color: #dc3545;
      }
      .settings-section {
        margin-bottom: 2rem;
      }
      #productItemsContainer .card, #salesScriptsContainer .card {
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
      }
      #productItemsContainer .card:hover, #salesScriptsContainer .card:hover {
        background-color: #e9ecef;
      }
      .card-header .btn-link {
        color: #212529;
        font-weight: 500;
        width: 100%;
        text-align: left;
      }
      .card-header .btn-link:hover {
        color: #0d6efd;
      }
      .card-header .btn-link:focus {
        box-shadow: none;
      }
      .collapse-icon {
        display: inline-block;
        width: 16px;
        margin-right: 8px;
        transition: transform 0.2s;
        font-size: 0.8em;
      }
      .card-header {
        cursor: pointer;
        user-select: none;
      }
      .card-header:hover {
        background-color: #e9ecef !important;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">üì± WhatsApp AI Dashboard</a>
        <span class="navbar-text text-white"
          >Advanced Business Configuration</span
        >
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Device Selection -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üîß Device Selection</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <select class="form-select" id="deviceSelect">
                    <option value="">Loading devices...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button
                    class="btn btn-outline-primary"
                    id="refreshDevicesBtn"
                  >
                    üîÑ Refresh
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="ai-settings-tab"
            data-bs-toggle="tab"
            data-bs-target="#ai-settings"
            type="button"
            role="tab"
          >
            ü§ñ AI Settings
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="business-config-tab"
            data-bs-toggle="tab"
            data-bs-target="#business-config"
            type="button"
            role="tab"
          >
            üíº Business Config
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="testing-tab"
            data-bs-toggle="tab"
            data-bs-target="#testing"
            type="button"
            role="tab"
          >
            üß™ Testing
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="settingsTabContent">
        <!-- AI Settings Tab -->
        <div class="tab-pane fade show active" id="ai-settings" role="tabpanel">
          <form id="aiSettingsForm">
            <div class="card settings-section">
              <div class="card-header">
                <h5 class="mb-0">ü§ñ AI Configuration</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check form-switch mb-3">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="aiEnabled"
                        name="aiEnabled"
                      />
                      <label class="form-check-label" for="aiEnabled"
                        >Enable AI Assistant</label
                      >
                    </div>
                    <div class="form-check form-switch mb-3">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="aiAutoReply"
                        name="aiAutoReply"
                      />
                      <label class="form-check-label" for="aiAutoReply"
                        >Auto Reply</label
                      >
                    </div>
                    <div class="form-check form-switch mb-3">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="aiTriggerRequired"
                        name="aiTriggerRequired"
                      />
                      <label class="form-check-label" for="aiTriggerRequired"
                        >Require Triggers
                        <small class="text-muted"
                          >(If off, AI responds to any message)</small
                        ></label
                      >
                    </div>
                    <div class="form-check form-switch mb-3">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="conversationMemoryEnabled"
                        name="conversationMemoryEnabled"
                      />
                      <label
                        class="form-check-label"
                        for="conversationMemoryEnabled"
                        >Conversation Memory</label
                      >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="aiBotName" class="form-label">Bot Name</label>
                      <input
                        type="text"
                        class="form-control"
                        id="aiBotName"
                        name="aiBotName"
                        placeholder="Assistant"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="aiLanguage" class="form-label"
                        >Primary Language</label
                      >
                      <select
                        class="form-select"
                        id="aiLanguage"
                        name="aiLanguage"
                      >
                        <option value="id">Bahasa Indonesia</option>
                        <option value="en">English</option>
                        <option value="ms">Bahasa Melayu</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="aiPromptTemplate" class="form-label"
                    >System Prompt</label
                  >
                  <textarea
                    class="form-control"
                    id="aiPromptTemplate"
                    name="aiPromptTemplate"
                    rows="4"
                    placeholder="You are a helpful AI assistant..."
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label for="aiTriggers" class="form-label"
                    >Trigger Words</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="aiTriggers"
                    name="aiTriggers"
                    placeholder="@help, @support, @ai"
                  />
                  <small class="text-muted"
                    >Comma-separated trigger words</small
                  >
                </div>

                <div class="mb-3">
                  <label for="aiRules" class="form-label">AI Rules</label>
                  <textarea
                    class="form-control"
                    id="aiRules"
                    name="aiRules"
                    rows="3"
                    placeholder="- Always be polite&#10;- Provide accurate information&#10;- Escalate complex issues"
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- AI Provider Settings -->
            <div class="card settings-section">
              <div class="card-header">
                <h5 class="mb-0">üîÄ AI Provider Configuration</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="aiProvider" class="form-label"
                        >Primary AI Provider</label
                      >
                      <select
                        class="form-select"
                        id="aiProvider"
                        name="aiProvider"
                      >
                        <option value="openai">ü§ñ OpenAI (GPT-3.5/4)</option>
                        <option value="deepseek">
                          üí∞ DeepSeek (90% cheaper)
                        </option>
                        <option value="claude">üéØ Claude (High quality)</option>
                        <option value="gemini">
                          üìö Gemini (Large context)
                        </option>
                        <option value="groq">‚ö° Groq (Ultra-fast)</option>
                      </select>
                      <small class="text-muted"
                        >Primary provider for AI responses</small
                      >
                    </div>

                    <div class="mb-3">
                      <label for="aiFallbackProvider" class="form-label"
                        >Fallback Provider</label
                      >
                      <select
                        class="form-select"
                        id="aiFallbackProvider"
                        name="aiFallbackProvider"
                      >
                        <option value="">No fallback</option>
                        <option value="openai">ü§ñ OpenAI</option>
                        <option value="deepseek">üí∞ DeepSeek</option>
                        <option value="claude">üéØ Claude</option>
                        <option value="gemini">üìö Gemini</option>
                        <option value="groq">‚ö° Groq</option>
                      </select>
                      <small class="text-muted">Backup if primary fails</small>
                    </div>

                    <div class="mb-3" id="aiModelSection">
                      <label for="aiModel" class="form-label">AI Model</label>
                      <select class="form-select" id="aiModel" name="aiModel">
                        <option value="">Use provider default</option>
                      </select>
                      <small class="text-muted"
                        >Available models for selected provider</small
                      >
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="aiTemperature" class="form-label"
                        >üé® Creativity (Temperature)</label
                      >
                      <div class="row">
                        <div class="col-8">
                          <input
                            type="range"
                            class="form-range"
                            id="aiTemperatureRange"
                            min="0"
                            max="2"
                            step="0.1"
                            value="0.7"
                          />
                        </div>
                        <div class="col-4">
                          <input
                            type="number"
                            class="form-control form-control-sm"
                            id="aiTemperature"
                            name="aiTemperature"
                            min="0"
                            max="2"
                            step="0.1"
                            value="0.7"
                          />
                        </div>
                      </div>
                      <small class="text-muted">
                        <span class="badge bg-primary">0.0-0.3</span> Focused
                        <span class="badge bg-info">0.4-0.7</span> Balanced
                        <span class="badge bg-warning">0.8-2.0</span> Creative
                      </small>
                    </div>

                    <div class="mb-3">
                      <label for="aiMaxTokens" class="form-label"
                        >üìè Response Length</label
                      >
                      <select
                        class="form-select"
                        id="aiMaxTokens"
                        name="aiMaxTokens"
                      >
                        <option value="150">üî∏ Short (150 tokens)</option>
                        <option value="300">üîπ Medium (300 tokens)</option>
                        <option value="500" selected>
                          üî∂ Standard (500 tokens)
                        </option>
                        <option value="1000">üî∑ Long (1000 tokens)</option>
                        <option value="2000">üî∏ Very Long (2000 tokens)</option>
                      </select>
                      <small class="text-muted"
                        >Longer responses cost more</small
                      >
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-12">
                    <div class="card bg-light">
                      <div class="card-body py-2">
                        <h6 class="card-title mb-2">üí° Provider Comparison</h6>
                        <div class="row small">
                          <div class="col-md-2">
                            <strong>DeepSeek:</strong> $0.0001/1K tokens
                          </div>
                          <div class="col-md-2">
                            <strong>OpenAI:</strong> $0.0015/1K tokens
                          </div>
                          <div class="col-md-2">
                            <strong>Claude:</strong> $0.003/1K tokens
                          </div>
                          <div class="col-md-3">
                            <strong>Groq:</strong> $0.0001/1K tokens (fast)
                          </div>
                          <div class="col-md-3">
                            <strong>Gemini:</strong> $0.0001/1K tokens (large
                            context)
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                üíæ Save AI Settings
              </button>
            </div>
          </form>
        </div>

        <!-- Business Configuration Tab -->
        <div class="tab-pane fade" id="business-config" role="tabpanel">
          <form id="businessConfigForm">
            <div class="card settings-section">
              <div class="card-header">
                <h5 class="mb-0">üíº Business Intelligence</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="businessType" class="form-label"
                        >Business Type</label
                      >
                      <select
                        class="form-select"
                        id="businessType"
                        name="businessType"
                      >
                        <option value="">Loading business types...</option>
                        <option value="custom">Custom</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <label for="businessLanguage" class="form-label"
                        >Template Language</label
                      >
                      <select
                        class="form-select"
                        id="businessLanguage"
                        name="businessLanguage"
                      >
                        <option value="id">Bahasa Indonesia</option>
                        <option value="en">English</option>
                        <option value="ms">Bahasa Melayu</option>
                      </select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Template Actions</label>
                      <div class="d-grid gap-2">
                        <button
                          type="button"
                          class="btn btn-outline-primary"
                          id="loadBusinessTemplate"
                        >
                          üîÑ Load Business Template
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-info btn-sm"
                          id="previewTemplate"
                        >
                          üëÅÔ∏è Preview Template
                        </button>
                        <div id="templateStatus" class="text-muted small">
                          Select business type to load template
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Product Knowledge Base - Structured -->
                <div class="card mb-3">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üì¶ Product Knowledge Base</h6>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary"
                      id="addProductItemBtn"
                    >
                      ‚ûï Add Product/Service
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="productItemsContainer">
                      <!-- Product items will be dynamically added here -->
                    </div>
                    <div class="mb-3 mt-3">
                      <label for="productKnowledgeOther" class="form-label"
                        >Other Product Information</label
                      >
                      <textarea
                        class="form-control"
                        id="productKnowledgeOther"
                        name="productKnowledgeOther"
                        rows="3"
                        placeholder="Additional product information, policies, inventory notes, etc..."
                      ></textarea>
                      <small class="text-muted"
                        >Any other product-related information not covered above</small
                      >
                    </div>
                  </div>
                </div>

                <!-- Sales Scripts - Structured -->
                <div class="card mb-3">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üí¨ Sales Scripts & Responses</h6>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary"
                      id="addSalesScriptItemBtn"
                    >
                      ‚ûï Add Script
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="salesScriptsContainer">
                      <!-- Sales script items will be dynamically added here -->
                    </div>
                    <div class="mb-3 mt-3">
                      <label for="salesScriptsDetailed" class="form-label"
                        >Detailed Response Commands</label
                      >
                      <textarea
                        class="form-control"
                        id="salesScriptsDetailed"
                        name="salesScriptsDetailed"
                        rows="4"
                        placeholder="Detailed AI response commands, conversation flow, escalation procedures..."
                      ></textarea>
                      <small class="text-muted"
                        >Detailed instructions for AI on how to handle sales conversations</small
                      >
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="upsellStrategies" class="form-label"
                        >Upsell Strategies</label
                      >
                      <textarea
                        class="form-control"
                        id="upsellStrategies"
                        name="upsellStrategies"
                        rows="3"
                        placeholder="Cross-selling and upselling techniques..."
                      ></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="objectionHandling" class="form-label"
                        >Objection Handling</label
                      >
                      <textarea
                        class="form-control"
                        id="objectionHandling"
                        name="objectionHandling"
                        rows="3"
                        placeholder="Common objections and responses..."
                      ></textarea>
                    </div>
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-success">
                    üíæ Save Business Configuration
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- Testing Tab -->
        <div class="tab-pane fade" id="testing" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üß™ AI Response Testing</h5>
            </div>
            <div class="card-body">
              <form id="aiTestForm">
                <div class="mb-3">
                  <label for="testMessage" class="form-label"
                    >Test Message</label
                  >
                  <textarea
                    class="form-control"
                    id="testMessage"
                    name="testMessage"
                    rows="3"
                    placeholder="Type a message to test AI response..."
                  ></textarea>
                </div>
                <div class="mb-3">
                  <button type="submit" class="btn btn-primary">
                    üîÆ Test AI Response
                  </button>
                </div>
                <div id="testResult" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Configuration
      const API_BASE_URL = "/api/whatsapp";
      const BUSINESS_API_URL = "/api/business-templates";
      const API_TOKEN = "test123";

      let currentDeviceId = null;
      let currentDeviceUserId = null;

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        refreshDevices();
        loadBusinessTypes();
        initializeProviderModels();

        // Event listeners
        document
          .getElementById("deviceSelect")
          .addEventListener("change", onDeviceSelect);
        document
          .getElementById("businessType")
          .addEventListener("change", onBusinessTypeChange);
        document
          .getElementById("businessLanguage")
          .addEventListener("change", onBusinessTypeChange);
        document
          .getElementById("loadBusinessTemplate")
          .addEventListener("click", loadSelectedTemplate);
        document
          .getElementById("previewTemplate")
          .addEventListener("click", previewSelectedTemplate);
        document
          .getElementById("aiSettingsForm")
          .addEventListener("submit", updateDeviceAI);
        document
          .getElementById("businessConfigForm")
          .addEventListener("submit", saveBusinessConfig);
        document
          .getElementById("aiTestForm")
          .addEventListener("submit", testAIResponse);
        document
          .getElementById("aiProvider")
          .addEventListener("change", onProviderChange);
        
        // Add event listeners for buttons (CSP compliance)
        document.getElementById("refreshDevicesBtn")?.addEventListener("click", refreshDevices);
        document.getElementById("addProductItemBtn")?.addEventListener("click", () => addProductItem());
        document.getElementById("addSalesScriptItemBtn")?.addEventListener("click", () => addSalesScriptItem());
        document.getElementById("loadTemplateFromModalBtn")?.addEventListener("click", loadSelectedTemplate);
        
        // Temperature controls
        document.getElementById("aiTemperatureRange")?.addEventListener("input", function() {
          updateTemperatureValue(this.value);
        });
        document.getElementById("aiTemperature")?.addEventListener("change", function() {
          updateTemperatureRange(this.value);
        });
        
        // Event delegation for dynamically added remove buttons
        document.getElementById("productItemsContainer")?.addEventListener("click", function(e) {
          if (e.target.classList.contains("remove-product-item")) {
            const itemId = e.target.getAttribute("data-item-id");
            removeProductItem(itemId);
          }
        });
        
        document.getElementById("salesScriptsContainer")?.addEventListener("click", function(e) {
          if (e.target.classList.contains("remove-sales-script-item")) {
            const itemId = e.target.getAttribute("data-item-id");
            removeSalesScriptItem(itemId);
          }
        });
      });

      // Load available business types
      async function loadBusinessTypes() {
        try {
          const response = await fetch(`${BUSINESS_API_URL}/types`);
          const data = await response.json();

          if (data.success) {
            const select = document.getElementById("businessType");
            select.innerHTML =
              '<option value="">Select business type...</option>';

            data.businessTypes.forEach((type) => {
              const option = document.createElement("option");
              option.value = type;
              option.textContent = formatBusinessType(type);
              select.appendChild(option);
            });
            
            // Add custom option
            const customOption = document.createElement("option");
            customOption.value = "custom";
            customOption.textContent = "üîß Custom";
            select.appendChild(customOption);
          }
        } catch (error) {
          console.error("Failed to load business types:", error);
        }
      }

      // Format business type for display
      function formatBusinessType(type) {
        const types = {
          ecommerce: "üõí E-commerce",
          restaurant: "üçï Restaurant",
          healthcare: "üè• Healthcare",
          education: "üìö Education",
          "real-estate": "üè† Real Estate",
          travel: "‚úàÔ∏è Travel",
          automotive: "üöó Automotive",
          finance: "üí∞ Finance",
          beauty: "üíÑ Beauty",
        };
        return types[type] || type.charAt(0).toUpperCase() + type.slice(1);
      }

      // Load business template
      async function loadSelectedTemplate() {
        const businessType = document.getElementById("businessType").value;
        const language = document.getElementById("businessLanguage").value;

        if (!businessType || businessType === "custom") {
          document.getElementById("templateStatus").textContent =
            businessType === "custom" 
              ? "Custom business type - no template available"
              : "Please select a business type first";
          return;
        }

        try {
          document.getElementById("templateStatus").textContent =
            "Loading template...";
          const response = await fetch(
            `${BUSINESS_API_URL}/${businessType}/${language}`
          );
          const data = await response.json();

          if (data.success && data.template) {
            const template = data.template;

            // Fill form fields with template data
            document.getElementById("aiBotName").value = template.botName || "";
            document.getElementById("aiPromptTemplate").value =
              template.prompt || "";
            
            // Handle product knowledge - convert template format to new structure
            const productKnowledge = template.productKnowledge || "";
            if (typeof productKnowledge === "string" && productKnowledge.trim()) {
              // Legacy format - put in otherDescription
              document.getElementById("productKnowledgeOther").value = productKnowledge;
              loadProductItems([]);
            } else if (typeof productKnowledge === "object") {
              loadProductItems(productKnowledge.items || []);
              document.getElementById("productKnowledgeOther").value = productKnowledge.otherDescription || "";
            } else {
              loadProductItems([]);
              document.getElementById("productKnowledgeOther").value = "";
            }
            
            // Handle sales scripts - convert template format to new structure
            const salesScripts = template.salesScripts || "";
            if (typeof salesScripts === "string" && salesScripts.trim()) {
              // Legacy format - put in detailedResponse
              document.getElementById("salesScriptsDetailed").value = salesScripts;
              loadSalesScriptItems([]);
            } else if (typeof salesScripts === "object") {
              loadSalesScriptItems(salesScripts.items || []);
              document.getElementById("salesScriptsDetailed").value = salesScripts.detailedResponse || "";
            } else {
              loadSalesScriptItems([]);
              document.getElementById("salesScriptsDetailed").value = "";
            }
            
            document.getElementById("aiRules").value =
              template.businessRules || "";
            document.getElementById("aiTriggers").value =
              template.triggers || "";

            // Fill additional template fields if they exist
            if (document.getElementById("upsellStrategies")) {
              document.getElementById("upsellStrategies").value =
                typeof template.upsellStrategies === "object"
                  ? Object.entries(template.upsellStrategies || {})
                      .map(([key, value]) => `${key}: ${value}`)
                      .join("\n")
                  : template.upsellStrategies || "";
            }
            if (document.getElementById("objectionHandling")) {
              document.getElementById("objectionHandling").value =
                typeof template.objectionHandling === "object"
                  ? Object.entries(template.objectionHandling || {})
                      .map(([key, value]) => `${key}: ${value}`)
                      .join("\n")
                  : template.objectionHandling || "";
            }

            document.getElementById("templateStatus").innerHTML = `
              <span class="text-success">‚úÖ Template loaded successfully!</span><br>
              <small>${formatBusinessType(businessType)} - ${getLanguageName(
              language
            )}</small>
            `;
          } else {
            document.getElementById("templateStatus").textContent =
              "Template not found for this business type and language";
          }
        } catch (error) {
          console.error("Failed to load template:", error);
          document.getElementById("templateStatus").textContent =
            "Failed to load template";
        }
      }

      // Get language display name
      function getLanguageName(code) {
        const languages = {
          id: "Bahasa Indonesia",
          en: "English",
          ms: "Bahasa Melayu",
        };
        return languages[code] || code;
      }

      // Preview selected template
      async function previewSelectedTemplate() {
        const businessType = document.getElementById("businessType").value;
        const language = document.getElementById("businessLanguage").value;

        if (!businessType || businessType === "custom") {
          alert(businessType === "custom" 
            ? "Custom business type - no template available to preview"
            : "Please select a business type first");
          return;
        }

        try {
          const response = await fetch(
            `${BUSINESS_API_URL}/${businessType}/${language}`
          );
          const data = await response.json();

          if (data.success && data.template) {
            const template = data.template;
            const previewHtml = `
              <div class="modal fade" id="templatePreviewModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">üìã Template Preview</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <h6><strong>Business Type:</strong> ${formatBusinessType(
                        businessType
                      )}</h6>
                      <h6><strong>Language:</strong> ${getLanguageName(
                        language
                      )}</h6>
                      <hr>
                      <h6>ü§ñ Bot Name:</h6>
                      <p class="small">${
                        template.botName || "Not specified"
                      }</p>
                      <h6>üìù Prompt:</h6>
                      <p class="small">${(
                        template.prompt || "Not specified"
                      ).substring(0, 200)}${
              template.prompt && template.prompt.length > 200 ? "..." : ""
            }</p>
                      <h6>üì¶ Product Knowledge:</h6>
                      <p class="small">${(
                        template.productKnowledge || "Not specified"
                      ).substring(0, 200)}${
              template.productKnowledge &&
              template.productKnowledge.length > 200
                ? "..."
                : ""
            }</p>
                      <h6>üí¨ Sales Scripts:</h6>
                      <p class="small">${(
                        template.salesScripts || "Not specified"
                      ).substring(0, 200)}${
              template.salesScripts && template.salesScripts.length > 200
                ? "..."
                : ""
            }</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="loadTemplateFromModalBtn">
                        üîÑ Load This Template
                      </button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById(
              "templatePreviewModal"
            );
            if (existingModal) {
              existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML("beforeend", previewHtml);

            // Show modal
            const modal = new bootstrap.Modal(
              document.getElementById("templatePreviewModal")
            );
            modal.show();
          } else {
            alert("Template not found for this business type and language");
          }
        } catch (error) {
          console.error("Failed to preview template:", error);
          alert("Failed to preview template");
        }
      }

      // Handle business type change
      function onBusinessTypeChange() {
        document.getElementById("templateStatus").textContent =
          "Click 'Load Business Template' to apply selected template";
      }

      // Load devices
      async function refreshDevices() {
        try {
          const response = await fetch(`${API_BASE_URL}/sessions`, {
            headers: { "X-API-Token": API_TOKEN },
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          const select = document.getElementById("deviceSelect");
          select.innerHTML = '<option value="">Select a device...</option>';

          data.sessions.forEach((device) => {
            const option = document.createElement("option");
            option.value = device.id;
            option.textContent = `${device.alias} (${device.sessionId}) - ${device.status}`;
            option.dataset.device = JSON.stringify(device);
            select.appendChild(option);
          });

          console.log(`‚úÖ Loaded ${data.sessions.length} devices`);
        } catch (error) {
          console.error("Failed to load devices:", error);
        }
      }

      // Handle device selection
      function onDeviceSelect() {
        const select = document.getElementById("deviceSelect");
        currentDeviceId = select.value;

        if (currentDeviceId) {
          loadDeviceAI();
        }
      }

      // Load device AI settings
      async function loadDeviceAI() {
        if (!currentDeviceId) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/devices/${currentDeviceId}/settings/ai`,
            {
              headers: { "X-API-Token": API_TOKEN },
            }
          );

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();

          // Store device userId for file uploads
          if (data.userId) {
            currentDeviceUserId = data.userId;
          }

          // Populate form fields
          document.getElementById("aiEnabled").checked = Boolean(
            data.aiEnabled
          );
          document.getElementById("aiAutoReply").checked = Boolean(
            data.aiAutoReply
          );
          document.getElementById("aiTriggerRequired").checked = Boolean(
            data.aiTriggerRequired
          );
          document.getElementById("conversationMemoryEnabled").checked =
            Boolean(data.conversationMemoryEnabled);
          document.getElementById("aiBotName").value = data.aiBotName || "";
          document.getElementById("aiLanguage").value = data.aiLanguage || "id";
          document.getElementById("aiMaxTokens").value =
            data.aiMaxTokens || 500;
          document.getElementById("aiTemperature").value =
            data.aiTemperature || 0.7;
          document.getElementById("aiPromptTemplate").value =
            data.aiPromptTemplate || "";
          document.getElementById("aiTriggers").value = data.aiTriggers
            ? data.aiTriggers.join(", ")
            : "";
          document.getElementById("aiRules").value = data.aiRules
            ? data.aiRules.join("\n")
            : "";

          // AI Provider settings
          document.getElementById("aiProvider").value =
            data.aiProvider || "openai";
          document.getElementById("aiFallbackProvider").value =
            data.aiFallbackProvider || "";

          // Update models for current provider
          onProviderChange();
          setTimeout(() => {
            document.getElementById("aiModel").value = data.aiModel || "";
          }, 100);

          // Update temperature controls
          updateTemperatureValue(data.aiTemperature || 0.7);
          updateTemperatureRange(data.aiTemperature || 0.7);

          // Business fields - structured format
          // Handle both legacy string format and new structured format
          let productKnowledge = data.productKnowledge;
          if (!productKnowledge) {
            productKnowledge = { items: [], otherDescription: "" };
          } else if (typeof productKnowledge === "string") {
            // Legacy format - convert to structured
            productKnowledge = { items: [], otherDescription: productKnowledge };
          } else if (!productKnowledge.items) {
            // Ensure items array exists
            productKnowledge = { items: [], otherDescription: productKnowledge.otherDescription || "" };
          }
          
          let salesScripts = data.salesScripts;
          if (!salesScripts) {
            salesScripts = { items: [], detailedResponse: "" };
          } else if (typeof salesScripts === "string") {
            // Legacy format - convert to structured
            salesScripts = { items: [], detailedResponse: salesScripts };
          } else if (!salesScripts.items) {
            // Ensure items array exists
            salesScripts = { items: [], detailedResponse: salesScripts.detailedResponse || "" };
          }
          
          // Load product knowledge items
          console.log("Loading product knowledge:", productKnowledge);
          const productItems = Array.isArray(productKnowledge.items) ? productKnowledge.items : [];
          console.log("Product items array:", productItems, "Length:", productItems.length);
          loadProductItems(productItems);
          const productOtherEl = document.getElementById("productKnowledgeOther");
          if (productOtherEl) {
            productOtherEl.value = productKnowledge.otherDescription || "";
          }
          
          // Load sales script items
          console.log("Loading sales scripts:", salesScripts);
          const salesItems = Array.isArray(salesScripts.items) ? salesScripts.items : [];
          console.log("Sales script items array:", salesItems, "Length:", salesItems.length);
          loadSalesScriptItems(salesItems);
          const salesDetailedEl = document.getElementById("salesScriptsDetailed");
          if (salesDetailedEl) {
            salesDetailedEl.value = salesScripts.detailedResponse || "";
          }
          
          document.getElementById("businessType").value = data.businessType || "";

          // Additional business fields
          if (document.getElementById("upsellStrategies")) {
            document.getElementById("upsellStrategies").value =
              typeof data.upsellStrategies === "object"
                ? Object.entries(data.upsellStrategies || {})
                    .map(([key, value]) => `${key}: ${value}`)
                    .join("\n")
                : data.upsellStrategies || "";
          }
          if (document.getElementById("objectionHandling")) {
            document.getElementById("objectionHandling").value =
              typeof data.objectionHandling === "object"
                ? Object.entries(data.objectionHandling || {})
                    .map(([key, value]) => `${key}: ${value}`)
                    .join("\n")
                : data.objectionHandling || "";
          }

          console.log("‚úÖ Device AI settings loaded");
        } catch (error) {
          console.error("Failed to load device AI settings:", error);
        }
      }

      // Update device AI settings
      async function updateDeviceAI(event) {
        event.preventDefault();
        if (!currentDeviceId) return;

        const form = event.target;
        const formData = new FormData(form);

        const settings = {
          aiEnabled: formData.has("aiEnabled"),
          aiAutoReply: formData.has("aiAutoReply"),
          aiTriggerRequired: formData.has("aiTriggerRequired"),
          conversationMemoryEnabled: formData.has("conversationMemoryEnabled"),
          aiBotName: formData.get("aiBotName"),
          aiLanguage: formData.get("aiLanguage"),
          aiMaxTokens: parseInt(formData.get("aiMaxTokens")),
          aiTemperature: parseFloat(formData.get("aiTemperature")),
          aiPromptTemplate: formData.get("aiPromptTemplate"),
          aiTriggers: formData
            .get("aiTriggers")
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t),
          aiRules: formData
            .get("aiRules")
            .split("\n")
            .map((r) => r.trim())
            .filter((r) => r),
          // AI Provider settings
          aiProvider: formData.get("aiProvider"),
          aiFallbackProvider: formData.get("aiFallbackProvider"),
          aiModel: formData.get("aiModel"),
          productKnowledge: collectProductKnowledge(),
          salesScripts: collectSalesScripts(),
          businessType: formData.get("businessType"),
          upsellStrategies:
            document.getElementById("upsellStrategies")?.value || "",
          objectionHandling:
            document.getElementById("objectionHandling")?.value || "",
        };

        try {
          const response = await fetch(
            `${API_BASE_URL}/devices/${currentDeviceId}/settings/ai`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-API-Token": API_TOKEN,
              },
              body: JSON.stringify(settings),
            }
          );

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          
          // Reload form with updated data (response has nested 'settings' object)
          if (result.settings) {
            // Populate form with returned settings
            const settings = result.settings;
            
            // Update AI settings
            document.getElementById("aiEnabled").checked = Boolean(settings.aiEnabled);
            document.getElementById("aiAutoReply").checked = Boolean(settings.aiAutoReply);
            document.getElementById("aiTriggerRequired").checked = Boolean(settings.aiTriggerRequired);
            document.getElementById("conversationMemoryEnabled").checked = Boolean(settings.conversationMemoryEnabled);
            document.getElementById("aiBotName").value = settings.aiBotName || "";
            document.getElementById("aiLanguage").value = settings.aiLanguage || "id";
            document.getElementById("aiMaxTokens").value = settings.aiMaxTokens || 500;
            document.getElementById("aiTemperature").value = settings.aiTemperature || 0.7;
            document.getElementById("aiPromptTemplate").value = settings.aiPromptTemplate || "";
            document.getElementById("aiTriggers").value = Array.isArray(settings.aiTriggers) 
              ? settings.aiTriggers.join(", ") 
              : (settings.aiTriggers || "");
            document.getElementById("aiRules").value = Array.isArray(settings.aiRules)
              ? settings.aiRules.join("\n")
              : (settings.aiRules || "");
            
            // Update provider settings
            document.getElementById("aiProvider").value = settings.aiProvider || "openai";
            document.getElementById("aiFallbackProvider").value = settings.aiFallbackProvider || "";
            onProviderChange();
            setTimeout(() => {
              document.getElementById("aiModel").value = settings.aiModel || "";
            }, 100);
            
            // Update temperature controls
            updateTemperatureValue(settings.aiTemperature || 0.7);
            updateTemperatureRange(settings.aiTemperature || 0.7);
            
            // Update business fields - structured format
            let productKnowledge = settings.productKnowledge || { items: [], otherDescription: "" };
            if (typeof productKnowledge === "string") {
              productKnowledge = { items: [], otherDescription: productKnowledge };
            } else if (!productKnowledge.items) {
              productKnowledge = { items: [], otherDescription: productKnowledge.otherDescription || "" };
            }
            
            let salesScripts = settings.salesScripts || { items: [], detailedResponse: "" };
            if (typeof salesScripts === "string") {
              salesScripts = { items: [], detailedResponse: salesScripts };
            } else if (!salesScripts.items) {
              salesScripts = { items: [], detailedResponse: salesScripts.detailedResponse || "" };
            }
            
            // Load product knowledge items
            loadProductItems(Array.isArray(productKnowledge.items) ? productKnowledge.items : []);
            const productOtherEl = document.getElementById("productKnowledgeOther");
            if (productOtherEl) {
              productOtherEl.value = productKnowledge.otherDescription || "";
            }
            
            // Load sales script items
            loadSalesScriptItems(Array.isArray(salesScripts.items) ? salesScripts.items : []);
            const salesDetailedEl = document.getElementById("salesScriptsDetailed");
            if (salesDetailedEl) {
              salesDetailedEl.value = salesScripts.detailedResponse || "";
            }
            
            document.getElementById("businessType").value = settings.businessType || "";
            
            // Update additional business fields
            if (document.getElementById("upsellStrategies")) {
              document.getElementById("upsellStrategies").value = settings.upsellStrategies || "";
            }
            if (document.getElementById("objectionHandling")) {
              document.getElementById("objectionHandling").value = settings.objectionHandling || "";
            }
          }
          
          alert("‚úÖ AI settings updated successfully!");
          console.log("AI settings updated:", result);
        } catch (error) {
          console.error("Failed to update AI settings:", error);
          alert("‚ùå Failed to update AI settings");
        }
      }

      // Save business configuration
      async function saveBusinessConfig(event) {
        event.preventDefault();

        if (!currentDeviceId) {
          alert("Please select a device first");
          return;
        }

        const settings = {
          productKnowledge: collectProductKnowledge(),
          salesScripts: collectSalesScripts(),
          businessType: document.getElementById("businessType").value,
          upsellStrategies:
            document.getElementById("upsellStrategies")?.value || "",
          objectionHandling:
            document.getElementById("objectionHandling")?.value || "",
        };

        try {
          const response = await fetch(
            `${API_BASE_URL}/devices/${currentDeviceId}/settings/ai`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-API-Token": API_TOKEN,
              },
              body: JSON.stringify(settings),
            }
          );

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          
          // Reload form with updated data
          if (result.settings) {
            const settings = result.settings;
            
            // Update business fields - structured format
            let productKnowledge = settings.productKnowledge || { items: [], otherDescription: "" };
            if (typeof productKnowledge === "string") {
              productKnowledge = { items: [], otherDescription: productKnowledge };
            } else if (!productKnowledge.items) {
              productKnowledge = { items: [], otherDescription: productKnowledge.otherDescription || "" };
            }
            
            let salesScripts = settings.salesScripts || { items: [], detailedResponse: "" };
            if (typeof salesScripts === "string") {
              salesScripts = { items: [], detailedResponse: salesScripts };
            } else if (!salesScripts.items) {
              salesScripts = { items: [], detailedResponse: salesScripts.detailedResponse || "" };
            }
            
            // Load product knowledge items
            loadProductItems(Array.isArray(productKnowledge.items) ? productKnowledge.items : []);
            const productOtherEl = document.getElementById("productKnowledgeOther");
            if (productOtherEl) {
              productOtherEl.value = productKnowledge.otherDescription || "";
            }
            
            // Load sales script items
            loadSalesScriptItems(Array.isArray(salesScripts.items) ? salesScripts.items : []);
            const salesDetailedEl = document.getElementById("salesScriptsDetailed");
            if (salesDetailedEl) {
              salesDetailedEl.value = salesScripts.detailedResponse || "";
            }
            
            document.getElementById("businessType").value = settings.businessType || "";
            
            // Update additional business fields
            if (document.getElementById("upsellStrategies")) {
              document.getElementById("upsellStrategies").value = settings.upsellStrategies || "";
            }
            if (document.getElementById("objectionHandling")) {
              document.getElementById("objectionHandling").value = settings.objectionHandling || "";
            }
          }
          
          alert("‚úÖ Business configuration saved successfully!");
        } catch (error) {
          console.error("Failed to save business config:", error);
          alert("‚ùå Failed to save business configuration");
        }
      }

      // Test AI response
      async function testAIResponse(event) {
        event.preventDefault();

        if (!currentDeviceId) {
          alert("Please select a device first");
          return;
        }

        const message = document.getElementById("testMessage").value.trim();
        if (!message) {
          alert("Please enter a test message");
          return;
        }

        const resultDiv = document.getElementById("testResult");
        resultDiv.innerHTML =
          '<div class="text-muted">ü§ñ Testing AI response...</div>';

        try {
          const response = await fetch(`${API_BASE_URL}/test-ai`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Token": API_TOKEN,
            },
            body: JSON.stringify({
              deviceId: currentDeviceId,
              message: message,
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const result = await response.json();

          if (result.success && result.response) {
            resultDiv.innerHTML = `
              <div class="alert alert-success">
                <h6>ü§ñ AI Response:</h6>
                <p class="mb-2">${result.response}</p>
                <small class="text-muted">
                  <strong>Settings:</strong> ${result.settings.botName} | 
                  Temp: ${result.settings.temperature} | 
                  Tokens: ${result.settings.maxTokens} | 
                  Lang: ${result.settings.language}
                </small>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="alert alert-warning">
                <h6>‚ö†Ô∏è No AI Response:</h6>
                <p class="mb-0">${
                  result.message || "AI did not generate a response"
                }</p>
              </div>
            `;
          }
        } catch (error) {
          console.error("Failed to test AI:", error);
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <h6>‚ùå Error:</h6>
              <p class="mb-0">${error.message}</p>
              <small class="text-muted">Make sure the server is running and try restarting it to pick up route changes.</small>
            </div>
          `;
        }
      }

      // AI Provider Models Configuration
      const AI_MODELS = {
        openai: [
          { value: "gpt-3.5-turbo", label: "GPT-3.5 Turbo (Fast & Cheap)" },
          { value: "gpt-4o-mini", label: "GPT-4o Mini (Better Quality)" },
          { value: "gpt-4o", label: "GPT-4o (Best Quality)" },
          { value: "gpt-4-turbo", label: "GPT-4 Turbo (Advanced)" },
        ],
        deepseek: [
          { value: "deepseek-chat", label: "DeepSeek Chat (General)" },
          { value: "deepseek-coder", label: "DeepSeek Coder (Programming)" },
          { value: "deepseek-math", label: "DeepSeek Math (Mathematics)" },
        ],
        claude: [
          {
            value: "claude-3-5-sonnet-20241022",
            label: "Claude 3.5 Sonnet (Latest)",
          },
          {
            value: "claude-3-5-haiku-20241022",
            label: "Claude 3.5 Haiku (Fast)",
          },
          { value: "claude-3-opus-20240229", label: "Claude 3 Opus (Premium)" },
        ],
        gemini: [
          { value: "gemini-1.5-flash", label: "Gemini 1.5 Flash (Fast)" },
          { value: "gemini-1.5-pro", label: "Gemini 1.5 Pro (Advanced)" },
          { value: "gemini-pro", label: "Gemini Pro (Standard)" },
        ],
        groq: [
          {
            value: "llama-3.1-70b-versatile",
            label: "Llama 3.1 70B (Versatile)",
          },
          { value: "llama-3.1-8b-instant", label: "Llama 3.1 8B (Ultra Fast)" },
          {
            value: "mixtral-8x7b-32768",
            label: "Mixtral 8x7B (Large Context)",
          },
          { value: "gemma2-9b-it", label: "Gemma2 9B (Efficient)" },
        ],
      };

      // Initialize provider models
      function initializeProviderModels() {
        onProviderChange(); // Load models for default provider
      }

      // Handle provider change
      function onProviderChange() {
        const provider = document.getElementById("aiProvider").value;
        const modelSelect = document.getElementById("aiModel");

        // Clear existing options
        modelSelect.innerHTML =
          '<option value="">Use provider default</option>';

        if (provider && AI_MODELS[provider]) {
          AI_MODELS[provider].forEach((model) => {
            const option = document.createElement("option");
            option.value = model.value;
            option.textContent = model.label;
            modelSelect.appendChild(option);
          });
        }
      }

      // Temperature control functions
      function updateTemperatureValue(value) {
        document.getElementById("aiTemperature").value = value;
        document.getElementById("aiTemperatureRange").value = value;
      }

      function updateTemperatureRange(value) {
        document.getElementById("aiTemperature").value = value;
        document.getElementById("aiTemperatureRange").value = value;
      }

      // Handle device selection
      function onDeviceSelect() {
        const select = document.getElementById("deviceSelect");
        currentDeviceId = select.value;

        if (currentDeviceId) {
          loadDeviceAI();
        }
      }

      // Product Knowledge Management Functions
      let productItemCounter = 0;

      function addProductItem(item = null) {
        const container = document.getElementById("productItemsContainer");
        const itemId = item ? item.id : `product_${productItemCounter++}`;
        const collapseId = `productCollapse_${itemId}`;
        const itemName = item?.name || "New Product/Service Item";
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "card mb-2";
        itemDiv.id = `productItem_${itemId}`;
        
        // Create structure with collapsible header
        itemDiv.innerHTML = `
          <div class="card-header bg-light p-2">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-link text-decoration-none text-start p-0 flex-grow-1" 
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#${collapseId}" 
                      aria-expanded="false"
                      aria-controls="${collapseId}">
                <span class="collapse-icon">‚ñ∂</span>
                <span id="productThumbnail_${itemId}" class="me-2" style="display: none;">
                  <img id="productThumbnailImg_${itemId}" src="" alt="" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;">
                </span>
                <strong id="productHeader_${itemId}">${itemName}</strong>
                <small class="text-muted ms-2" id="productSubheader_${itemId}"></small>
              </button>
              <button type="button" class="btn btn-sm btn-danger remove-product-item ms-2" data-item-id="${itemId}">
                üóëÔ∏è Remove
              </button>
            </div>
          </div>
          <div id="${collapseId}" class="collapse">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label small">Name *</label>
                  <input type="text" class="form-control form-control-sm" 
                    id="productName_${itemId}" 
                    placeholder="Product/Service name"
                    required>
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label small">Price</label>
                  <input type="text" class="form-control form-control-sm" 
                    id="productPrice_${itemId}" 
                    placeholder="e.g., Rp 100.000 or $50">
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label small">Description</label>
                <textarea class="form-control form-control-sm" 
                  id="productDescription_${itemId}" 
                  rows="2"
                  placeholder="Product/service description, features, specifications..."></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label small">Promo/Offer (Optional)</label>
                <input type="text" class="form-control form-control-sm" 
                  id="productPromo_${itemId}" 
                  placeholder="e.g., Buy 2 Get 1 Free, 20% Discount">
              </div>
              <div class="mb-2">
                <label class="form-label small">Product Image (Optional)</label>
                <div class="d-flex gap-2 align-items-start">
                  <input type="file" 
                    class="form-control form-control-sm" 
                    id="productImage_${itemId}"
                    accept="image/jpeg,image/png,image/webp,image/gif"
                    style="flex: 1;">
                  <button type="button" 
                    class="btn btn-sm btn-outline-secondary" 
                    id="removeImage_${itemId}"
                    style="display: none;"
                    onclick="removeProductImage('${itemId}')">
                    Remove
                  </button>
                </div>
                <div id="productImagePreview_${itemId}" class="mt-2" style="display: none;">
                  <img id="productImagePreviewImg_${itemId}" 
                    src="" 
                    alt="Product preview" 
                    class="img-thumbnail" 
                    style="max-width: 200px; max-height: 200px; object-fit: cover;">
                </div>
                <input type="hidden" id="productImageUrl_${itemId}" value="">
                <small class="text-muted">Upload a product image (JPEG, PNG, WebP, GIF)</small>
              </div>
            </div>
          </div>
        `;
        
        // Append to DOM first so elements are accessible
        container.appendChild(itemDiv);
        
        // Update header when name/price changes
        const nameEl = document.getElementById(`productName_${itemId}`);
        const priceEl = document.getElementById(`productPrice_${itemId}`);
        const headerEl = document.getElementById(`productHeader_${itemId}`);
        const subheaderEl = document.getElementById(`productSubheader_${itemId}`);
        
        const updateHeader = () => {
          const name = nameEl?.value?.trim() || "New Product/Service Item";
          const price = priceEl?.value?.trim() || "";
          headerEl.textContent = name;
          subheaderEl.textContent = price ? ` - ${price}` : "";
        };
        
        nameEl?.addEventListener("input", updateHeader);
        priceEl?.addEventListener("input", updateHeader);
        
        // Handle image upload
        const imageInput = document.getElementById(`productImage_${itemId}`);
        const imagePreview = document.getElementById(`productImagePreview_${itemId}`);
        const imagePreviewImg = document.getElementById(`productImagePreviewImg_${itemId}`);
        const imageUrlInput = document.getElementById(`productImageUrl_${itemId}`);
        const removeImageBtn = document.getElementById(`removeImage_${itemId}`);
        
        imageInput?.addEventListener("change", async function(e) {
          const file = e.target.files[0];
          if (file) {
            // Validate file type
            if (!file.type.match(/^image\/(jpeg|png|webp|gif)$/)) {
              alert("Please select a valid image file (JPEG, PNG, WebP, or GIF)");
              e.target.value = "";
              return;
            }
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
              alert("Image size must be less than 10MB");
              e.target.value = "";
              return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
              imagePreviewImg.src = e.target.result;
              imagePreview.style.display = "block";
              removeImageBtn.style.display = "block";
              
              // Update thumbnail in header
              const thumbnail = document.getElementById(`productThumbnail_${itemId}`);
              const thumbnailImg = document.getElementById(`productThumbnailImg_${itemId}`);
              if (thumbnail && thumbnailImg) {
                thumbnailImg.src = e.target.result;
                thumbnail.style.display = "inline-block";
              }
            };
            reader.readAsDataURL(file);
            
            // Upload image to server
            try {
              const formData = new FormData();
              formData.append("file", file);
              // Use device's userId if available, otherwise use "default"
              const deviceUserId = currentDeviceUserId || (currentDeviceId ? "device_" + currentDeviceId : "default");
              formData.append("userId", deviceUserId);
              console.log("Uploading image with userId:", deviceUserId);
              
              const uploadResponse = await fetch(`${API_BASE_URL}/files/upload`, {
                method: "POST",
                headers: {
                  "X-API-Token": API_TOKEN,
                },
                body: formData,
              });
              
              if (!uploadResponse.ok) {
                throw new Error("Failed to upload image");
              }
              
              const uploadData = await uploadResponse.json();
              if (uploadData.success && uploadData.file) {
                // Store the file ID (we'll construct the preview URL when displaying)
                imageUrlInput.value = uploadData.file.id || "";
                console.log("Image uploaded successfully:", uploadData.file);
              } else {
                throw new Error(uploadData.error || "Upload failed");
              }
            } catch (error) {
              console.error("Error uploading image:", error);
              alert("Failed to upload image: " + error.message);
              e.target.value = "";
              imagePreview.style.display = "none";
              removeImageBtn.style.display = "none";
            }
          }
        });
        
        // Set values using DOM (handles special characters properly)
        // Must be done AFTER appending to DOM
        if (item) {
          if (nameEl) nameEl.value = item.name || "";
          if (priceEl) priceEl.value = item.price || "";
          const descEl = document.getElementById(`productDescription_${itemId}`);
          const promoEl = document.getElementById(`productPromo_${itemId}`);
          if (descEl) descEl.value = item.description || "";
          if (promoEl) promoEl.value = item.promo || "";
          
          // Load image if exists
          if (item.imageUrl || item.imageId) {
            // Extract image ID - support both imageId field and imageUrl field
            let imageId = item.imageId;
            if (!imageId && item.imageUrl) {
              // Extract ID from URL format: /api/whatsapp/files/{id}/preview
              const match = item.imageUrl.match(/\/files\/(\d+)\/preview/);
              imageId = match ? match[1] : null;
            }
            
            if (imageId) {
              imageUrlInput.value = imageId;
              // Construct preview URL from file ID
              const previewUrl = `/api/whatsapp/files/${imageId}/preview`;
              imagePreviewImg.src = previewUrl;
              imagePreview.style.display = "block";
              removeImageBtn.style.display = "block";
              
              // Update thumbnail in header
              const thumbnail = document.getElementById(`productThumbnail_${itemId}`);
              const thumbnailImg = document.getElementById(`productThumbnailImg_${itemId}`);
              if (thumbnail && thumbnailImg) {
                thumbnailImg.src = previewUrl;
                thumbnail.style.display = "inline-block";
              }
            }
          }
          
          updateHeader();
          console.log(`Loaded product item ${itemId}:`, item);
        }
        
        // Add collapse icon toggle
        const collapseBtn = itemDiv.querySelector(`[data-bs-target="#${collapseId}"]`);
        const collapseEl = document.getElementById(collapseId);
        if (collapseBtn && collapseEl) {
          collapseEl.addEventListener('show.bs.collapse', () => {
            collapseBtn.querySelector('.collapse-icon').textContent = '‚ñº';
          });
          collapseEl.addEventListener('hide.bs.collapse', () => {
            collapseBtn.querySelector('.collapse-icon').textContent = '‚ñ∂';
          });
        }
      }

      function removeProductItem(itemId) {
        const itemDiv = document.getElementById(`productItem_${itemId}`);
        if (itemDiv) {
          itemDiv.remove();
        }
      }
      
      function removeProductImage(itemId) {
        const imageInput = document.getElementById(`productImage_${itemId}`);
        const imagePreview = document.getElementById(`productImagePreview_${itemId}`);
        const imageUrlInput = document.getElementById(`productImageUrl_${itemId}`);
        const removeImageBtn = document.getElementById(`removeImage_${itemId}`);
        const thumbnail = document.getElementById(`productThumbnail_${itemId}`);
        
        if (imageInput) imageInput.value = "";
        if (imageUrlInput) imageUrlInput.value = "";
        if (imagePreview) imagePreview.style.display = "none";
        if (removeImageBtn) removeImageBtn.style.display = "none";
        if (thumbnail) thumbnail.style.display = "none";
      }

      function loadProductItems(items) {
        const container = document.getElementById("productItemsContainer");
        if (!container) {
          console.error("productItemsContainer not found!");
          return;
        }
        container.innerHTML = "";
        productItemCounter = 0; // Reset counter
        console.log("loadProductItems called with:", items, "Type:", typeof items, "IsArray:", Array.isArray(items));
        if (items && Array.isArray(items) && items.length > 0) {
          console.log(`Loading ${items.length} product items`);
          items.forEach((item, index) => {
            console.log(`Loading product item ${index}:`, item);
            // Use consistent ID format matching addProductItem
            addProductItem({ ...item, id: `product_${index}` });
          });
          console.log(`Finished loading ${items.length} product items`);
        } else {
          console.log("No product items to load or items is not an array");
        }
      }

      function collectProductKnowledge() {
        const items = [];
        const container = document.getElementById("productItemsContainer");
        const itemDivs = container.querySelectorAll('[id^="productItem_"]');
        
        itemDivs.forEach((div) => {
          const itemId = div.id.replace("productItem_", "");
          const nameEl = document.getElementById(`productName_${itemId}`);
          const name = nameEl?.value?.trim();
          if (name) {
            const imageId = document.getElementById(`productImageUrl_${itemId}`)?.value?.trim() || "";
            items.push({
              name: name,
              description: document.getElementById(`productDescription_${itemId}`)?.value?.trim() || "",
              price: document.getElementById(`productPrice_${itemId}`)?.value?.trim() || "",
              promo: document.getElementById(`productPromo_${itemId}`)?.value?.trim() || "",
              imageId: imageId, // Store file ID
              imageUrl: imageId ? `/api/whatsapp/files/${imageId}/preview` : "", // Store preview URL for backward compatibility
            });
          }
        });

        const result = {
          items: items,
          otherDescription: document.getElementById("productKnowledgeOther")?.value || "",
        };
        console.log("Collected product knowledge:", result);
        return result;
      }

      // Sales Scripts Management Functions
      let salesScriptCounter = 0;

      function addSalesScriptItem(item = null) {
        const container = document.getElementById("salesScriptsContainer");
        const itemId = item ? item.id : `script_${salesScriptCounter++}`;
        const collapseId = `scriptCollapse_${itemId}`;
        const scriptName = item?.name || "New Sales Script";
        
        const itemDiv = document.createElement("div");
        itemDiv.className = "card mb-2";
        itemDiv.id = `salesScriptItem_${itemId}`;
        
        // Create structure with collapsible header
        itemDiv.innerHTML = `
          <div class="card-header bg-light p-2">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-link text-decoration-none text-start p-0 flex-grow-1" 
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#${collapseId}" 
                      aria-expanded="false"
                      aria-controls="${collapseId}">
                <span class="collapse-icon">‚ñ∂</span>
                <strong id="scriptHeader_${itemId}">${scriptName}</strong>
              </button>
              <button type="button" class="btn btn-sm btn-danger remove-sales-script-item ms-2" data-item-id="${itemId}">
                üóëÔ∏è Remove
              </button>
            </div>
          </div>
          <div id="${collapseId}" class="collapse">
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label small">Script Name *</label>
                  <input type="text" class="form-control form-control-sm" 
                    id="scriptName_${itemId}" 
                    placeholder="e.g., Greeting, Closing, Follow-up"
                    required>
                </div>
                <div class="col-md-8 mb-2">
                  <label class="form-label small">Response/Description</label>
                  <textarea class="form-control form-control-sm" 
                    id="scriptResponse_${itemId}" 
                    rows="2"
                    placeholder="Script response or description..."></textarea>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Append to DOM first so elements are accessible
        container.appendChild(itemDiv);
        
        // Update header when name changes
        const nameEl = document.getElementById(`scriptName_${itemId}`);
        const headerEl = document.getElementById(`scriptHeader_${itemId}`);
        
        const updateHeader = () => {
          const name = nameEl?.value?.trim() || "New Sales Script";
          headerEl.textContent = name;
        };
        
        nameEl?.addEventListener("input", updateHeader);
        
        // Set values using DOM (handles special characters properly)
        // Must be done AFTER appending to DOM
        if (item) {
          if (nameEl) nameEl.value = item.name || "";
          const responseEl = document.getElementById(`scriptResponse_${itemId}`);
          if (responseEl) responseEl.value = item.response || "";
          updateHeader();
          console.log(`Loaded sales script item ${itemId}:`, item);
        }
        
        // Add collapse icon toggle
        const collapseBtn = itemDiv.querySelector(`[data-bs-target="#${collapseId}"]`);
        const collapseEl = document.getElementById(collapseId);
        if (collapseBtn && collapseEl) {
          collapseEl.addEventListener('show.bs.collapse', () => {
            collapseBtn.querySelector('.collapse-icon').textContent = '‚ñº';
          });
          collapseEl.addEventListener('hide.bs.collapse', () => {
            collapseBtn.querySelector('.collapse-icon').textContent = '‚ñ∂';
          });
        }
      }

      function removeSalesScriptItem(itemId) {
        const itemDiv = document.getElementById(`salesScriptItem_${itemId}`);
        if (itemDiv) {
          itemDiv.remove();
        }
      }

      function loadSalesScriptItems(items) {
        const container = document.getElementById("salesScriptsContainer");
        container.innerHTML = "";
        salesScriptCounter = 0; // Reset counter
        if (items && Array.isArray(items) && items.length > 0) {
          items.forEach((item, index) => {
            // Use consistent ID format
            addSalesScriptItem({ 
              ...item, 
              id: `script_${index}` 
            });
          });
        }
        console.log("Loaded sales script items:", items);
      }

      function collectSalesScripts() {
        const items = [];
        const container = document.getElementById("salesScriptsContainer");
        const itemDivs = container.querySelectorAll('[id^="salesScriptItem_"]');
        
        itemDivs.forEach((div) => {
          const itemId = div.id.replace("salesScriptItem_", "");
          const nameEl = document.getElementById(`scriptName_${itemId}`);
          const name = nameEl?.value?.trim();
          if (name) {
            items.push({
              name: name,
              response: document.getElementById(`scriptResponse_${itemId}`)?.value?.trim() || "",
            });
          }
        });

        const result = {
          items: items,
          detailedResponse: document.getElementById("salesScriptsDetailed")?.value || "",
        };
        console.log("Collected sales scripts:", result);
        return result;
      }
    </script>
  </body>
</html>
