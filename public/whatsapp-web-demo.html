<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Management - WhatsApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 380px;
            --info-panel-width: 320px;
            --header-height: 64px;
            --bg-dark: #111b21;
            --bg-panel: #202c33;
            --bg-chat: #0b141a;
            --bg-input: #2a3942;
            --incoming-bg: #202c33;
            --outgoing-bg: #005c4b;
            --ai-bg: #3d1f5c;
            --primary: #00a884;
            --primary-hover: #06cf9c;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --text-muted: #667781;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        #device-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-tabs {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .filter-tab {
            padding: 6px 12px;
            background: var(--bg-input);
            border: none;
            border-radius: 16px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-tab.active, .filter-tab:hover {
            background: var(--primary);
            color: white;
        }

        #chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            align-items: flex-start;
            gap: 12px;
            transition: background 0.15s;
        }

        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item.active { background: var(--bg-input); }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
            position: relative;
        }

        .avatar .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-panel);
        }

        .status-dot.ai { background: #8b5cf6; }
        .status-dot.human { background: var(--primary); }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 500;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }

        .chat-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-urgent { background: var(--danger); color: white; }
        .badge-high { background: var(--warning); color: black; }
        .badge-ai { background: #8b5cf6; color: white; }
        .badge-human { background: var(--primary); color: white; }
        .badge-label { background: #1e40af; color: white; }
        .badge-status { background: transparent; padding: 2px 4px; }
        .badge-agent { background: #0891b2; color: white; }
        .badge-unread { background: var(--primary); color: white; border-radius: 50%; min-width: 20px; text-align: center; }

        /* Main Chat Area */
        #main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
        }

        #chat-header {
            height: var(--header-height);
            background: var(--bg-panel);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info .avatar { width: 40px; height: 40px; font-size: 14px; }

        .chat-header-title h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .chat-header-title span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }

        .message.incoming {
            align-self: flex-start;
            background: var(--incoming-bg);
            border-top-left-radius: 2px;
        }

        .message.outgoing {
            align-self: flex-end;
            background: var(--outgoing-bg);
            border-top-right-radius: 2px;
        }

        .message.ai-generated {
            background: var(--ai-bg);
            border: 1px solid #8b5cf6;
        }

        .message-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .message-agent {
            font-size: 10px;
            color: var(--primary);
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .message-sender.ai { color: #a78bfa; }
        .message-sender.agent { color: var(--primary); }
        .message-sender.customer { color: #60a5fa; }

        .date-separator {
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 16px 0;
        }

        .date-separator span {
            background: var(--bg-input);
            padding: 4px 12px;
            border-radius: 8px;
        }

        #input-area {
            padding: 12px 16px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        #message-input::placeholder { color: var(--text-muted); }

        #send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #send-btn:hover { background: var(--primary-hover); }

        /* Info Panel */
        #info-panel {
            width: var(--info-panel-width);
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        #info-panel.show { display: flex; }

        .info-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-header h3 { font-size: 16px; font-weight: 600; }

        .info-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .info-section h4 {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .info-label { font-size: 13px; color: var(--text-secondary); }
        .info-value { font-size: 13px; font-weight: 500; }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-input);
            border-radius: 12px;
            cursor: pointer;
        }

        .toggle-switch.active { background: var(--primary); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle-switch.active::after { transform: translateX(20px); }

        select.info-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            margin-top: 8px;
        }

        .label-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .label-tag {
            padding: 4px 10px;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .label-tag.active { background: var(--primary); }
        .label-tag .remove { opacity: 0.7; }
        .label-tag .remove:hover { opacity: 1; }

        .add-label-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            margin-top: 8px;
        }

        textarea.notes-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            #info-panel { display: none !important; }
        }

        @media (max-width: 768px) {
            #sidebar { 
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                width: 100%;
                transform: translateX(0);
            }
            #sidebar.hidden { transform: translateX(-100%); }
            
            .mobile-back {
                display: flex !important;
                padding: 8px;
                background: none;
                border: none;
                color: var(--text-primary);
                cursor: pointer;
            }
        }

        @media (min-width: 769px) {
            .mobile-back { display: none !important; }
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h2>üí¨ CS Dashboard</h2>
                <select id="device-select">
                    <option value="">Select Device...</option>
                </select>
            </div>
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All</button>
                <button class="filter-tab" data-filter="open">Open</button>
                <button class="filter-tab" data-filter="pending">Pending</button>
                <button class="filter-tab" data-filter="urgent">Urgent</button>
                <button class="filter-tab" data-filter="human">My Chats</button>
            </div>
            <div id="chat-list">
                <div class="loading"><div class="spinner"></div>Loading chats...</div>
            </div>
        </div>

        <!-- Main Chat -->
        <div id="main-chat">
            <div id="chat-header" style="display:none;">
                <div class="chat-header-info">
                    <button class="mobile-back" onclick="showSidebar()">‚Üê Back</button>
                    <div class="avatar" id="header-avatar">FA</div>
                    <div class="chat-header-title">
                        <h3 id="header-name">Select a chat</h3>
                        <span id="header-phone">-</span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="btn btn-secondary" onclick="toggleInfoPanel()">‚ÑπÔ∏è Info</button>
                    <button id="takeover-btn" class="btn btn-primary" onclick="toggleTakeover()">ü§ñ AI Active</button>
                </div>
            </div>

            <div id="messages-container">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                    <h3>No chat selected</h3>
                    <p>Select a conversation from the left to start messaging</p>
                </div>
            </div>

            <div id="input-area" style="display:none;">
                <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                <button id="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

        <!-- Info Panel -->
        <div id="info-panel">
            <div class="info-header">
                <h3>Chat Details</h3>
                <button class="btn btn-secondary" onclick="toggleInfoPanel()">‚úï</button>
            </div>
            
            <div class="info-section">
                <h4>AI Control</h4>
                <div class="info-row">
                    <span class="info-label">AI Auto-Reply</span>
                    <div id="ai-toggle" class="toggle-switch active" onclick="toggleAI()"></div>
                </div>
                <div class="info-row">
                    <span class="info-label">Human Takeover</span>
                    <div id="human-toggle" class="toggle-switch" onclick="toggleHumanTakeover()"></div>
                </div>
            </div>

            <div class="info-section">
                <h4>Status & Priority</h4>
                <select id="status-select" class="info-select" onchange="updateChatSettings()">
                    <option value="open">üü¢ Open</option>
                    <option value="pending">üü° Pending</option>
                    <option value="resolved">üîµ Resolved</option>
                    <option value="closed">‚ö´ Closed</option>
                </select>
                <select id="priority-select" class="info-select" onchange="updateChatSettings()">
                    <option value="low">Low Priority</option>
                    <option value="normal">Normal</option>
                    <option value="high">‚ö†Ô∏è High Priority</option>
                    <option value="urgent">üî¥ Urgent</option>
                </select>
            </div>

            <div class="info-section">
                <h4>Labels</h4>
                <div id="labels-container" class="label-tags"></div>
                <input type="text" id="add-label" class="add-label-input" placeholder="Add label and press Enter" onkeypress="handleAddLabel(event)">
            </div>

            <div class="info-section">
                <h4>Agent</h4>
                <div class="info-row">
                    <span class="info-label">Assigned To</span>
                    <span id="assigned-agent" class="info-value">Unassigned</span>
                </div>
                <button class="btn btn-secondary" style="width:100%;margin-top:8px;" onclick="assignToMe()">Assign to Me</button>
            </div>

            <div class="info-section">
                <h4>Notes</h4>
                <textarea id="notes-input" class="notes-input" placeholder="Internal notes..." onchange="updateNotes()"></textarea>
            </div>
        </div>
    </div>

    <script>
    const API_URL = 'http://localhost:3000';
    const API_TOKEN = 'test123'; // Hardcoded for demo
    
    // Configurable Agent Info for Demo
    const currentAgentId = 'agent-007';
    const currentAgentName = 'James Bond'; // Demo Agent Name

    let devices = [];
    let chats = [];
    let currentDeviceId = null;
    let currentChat = null;
    let ws = null;

    // Init
    document.addEventListener('DOMContentLoaded', loadDevices);

    async function loadDevices() {
        try {
            const res = await fetch(`${API_URL}/api/whatsapp/devices`, {
                headers: { 'X-API-Token': API_TOKEN }
            });
            const data = await res.json();
            devices = data.sessions || data.devices || [];
            
            const select = document.getElementById('device-select');
            select.innerHTML = '<option value="">Select Device...</option>';
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = `${d.alias || d.sessionId} (${d.status})`;
                select.appendChild(opt);
            });
        } catch (e) {
            console.error('Failed to load devices:', e);
        }
    }

    document.getElementById('device-select').onchange = async function() {
        currentDeviceId = this.value;
        if (!currentDeviceId) return;
        
        const device = devices.find(d => d.id == currentDeviceId);
        connectWebSocket(device?.sessionId);
        await loadChats();
    };

    function connectWebSocket(sessionId) {
        if (ws) ws.close();
        if (!sessionId) return;

        ws = new WebSocket(`ws://${location.hostname}:3001?token=${API_TOKEN}`);
        ws.onopen = () => {
            ws.send(JSON.stringify({ type: 'subscribe', sessionId }));
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'messages.upsert') {
                handleNewMessage(data);
            }
        };
    }

    async function loadChats() {
        const container = document.getElementById('chat-list');
        container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading chats...</div>';
        
        try {
            const res = await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats`, {
                headers: { 'X-API-Token': API_TOKEN }
            });
            const data = await res.json();
            chats = data.chats || [];
            renderChatList();
        } catch (e) {
            container.innerHTML = '<div class="empty-state"><p>Error loading chats</p></div>';
        }
    }

    function renderChatList() {
        const container = document.getElementById('chat-list');
        container.innerHTML = '';

        if (chats.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No chats yet</p></div>';
            return;
        }

        chats.forEach(chat => {
            const el = document.createElement('div');
            el.className = 'chat-item' + (currentChat?.chatId === chat.chatId ? ' active' : '');
            el.onclick = () => openChat(chat);

            // Name logic - never show "Unknown"
            let name = chat.contactName || chat.name;
            if (!name || name === 'Unknown') {
                name = chat.phoneNumber || chat.chatId?.replace('@s.whatsapp.net', '');
            }
            const initials = name.substring(0, 2).toUpperCase();

            // Time format
            const time = chat.lastMessageTimestamp ? new Date(chat.lastMessageTimestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

            // Preview
            const preview = chat.lastMessageContent || 'No messages';

            // Badges - Status first, then priority, then mode, then agent, then labels
            let badges = '';
            
            // Status indicator (Open/Pending/Resolved/Closed)
            const statusIcons = { open: 'üü¢', pending: 'üü°', resolved: 'üîµ', closed: '‚ö´' };
            const status = chat.status || 'open';
            badges += `<span class="badge badge-status" title="${status}">${statusIcons[status] || 'üü¢'}</span>`;
            
            // Priority
            if (chat.priority === 'urgent') badges += '<span class="badge badge-urgent">üî¥ Urgent</span>';
            else if (chat.priority === 'high') badges += '<span class="badge badge-high">‚ö†Ô∏è High</span>';
            
            // AI/Human mode
            if (chat.humanTakeover) badges += '<span class="badge badge-human">üë§ Human</span>';
            else if (chat.aiEnabled !== false) badges += '<span class="badge badge-ai">ü§ñ AI</span>';

            // Assigned agent (if any)
            if (chat.assignedAgentName) {
                badges += `<span class="badge badge-agent" title="Assigned to ${chat.assignedAgentName}">üë§ ${chat.assignedAgentName}</span>`;
            }

            // Labels
            if (chat.labels && chat.labels.length > 0) {
                chat.labels.slice(0,3).forEach(l => badges += `<span class="badge badge-label">üè∑Ô∏è ${l}</span>`);
            }

            // Status dot on avatar
            const statusClass = chat.humanTakeover ? 'human' : 'ai';

            el.innerHTML = `
                <div class="avatar">
                    ${initials}
                    <div class="status-dot ${statusClass}"></div>
                </div>
                <div class="chat-content">
                    <div class="chat-top">
                        <span class="chat-name">${name}</span>
                        <span class="chat-time">${time}</span>
                    </div>
                    <div class="chat-preview">${preview}</div>
                    <div class="chat-badges">${badges}</div>
                </div>
            `;
            container.appendChild(el);
        });
    }

    async function openChat(chat) {
        currentChat = chat;
        
        // Update UI
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        
        // Header info
        let name = chat.contactName || chat.name;
        if (!name || name === 'Unknown') name = chat.phoneNumber || chat.chatId?.replace('@s.whatsapp.net', '');
        
        document.getElementById('header-name').textContent = name;
        document.getElementById('header-phone').textContent = chat.phoneNumber || chat.chatId;
        document.getElementById('header-avatar').textContent = name.substring(0,2).toUpperCase();
        
        // Update takeover button
        updateTakeoverButton();
        
        // Update info panel
        updateInfoPanel();
        
        // Load messages
        await loadMessages();
        
        // Hide sidebar on mobile
        if (window.innerWidth < 769) {
            document.getElementById('sidebar').classList.add('hidden');
        }
        
        renderChatList(); // Re-render to show active
    }

    async function loadMessages() {
        const container = document.getElementById('messages-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading messages...</div>';
        
        try {
            const encodedChatId = encodeURIComponent(currentChat.chatId);
            const res = await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats/${encodedChatId}/history?limit=100`, {
                headers: { 'X-API-Token': API_TOKEN }
            });
            const data = await res.json();
            const messages = data.messages || [];
            
            renderMessages(messages);
        } catch (e) {
            container.innerHTML = '<div class="empty-state"><p>Error loading messages</p></div>';
        }
    }

    function renderMessages(messages) {
        const container = document.getElementById('messages-container');
        container.innerHTML = '';

        if (messages.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No messages yet</p></div>';
            return;
        }

        // Sort oldest first (reverse chronological from DB)
        messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        let lastDate = null;

        messages.forEach(msg => {
            // Date separator
            const msgDate = new Date(msg.timestamp).toLocaleDateString();
            if (msgDate !== lastDate) {
                lastDate = msgDate;
                const sep = document.createElement('div');
                sep.className = 'date-separator';
                sep.innerHTML = `<span>${msgDate}</span>`;
                container.appendChild(sep);
            }

            appendMessageToView(msg);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    function appendMessageToView(msg) {
        const container = document.getElementById('messages-container');
        const div = document.createElement('div');
        
        const isOutgoing = msg.direction === 'outgoing' || msg.fromMe || msg.key?.fromMe;
        div.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
        
        if (msg.isAiGenerated) div.classList.add('ai-generated');

        // Content
        let content = msg.content || '';
        if (msg.message?.conversation) content = msg.message.conversation;
        else if (msg.message?.extendedTextMessage?.text) content = msg.message.extendedTextMessage.text;
        else if (msg.messageType === 'image' || msg.message?.imageMessage) {
            const caption = msg.caption || msg.message?.imageMessage?.caption || '';
            content = `üì∑ [Image]${caption ? ' ' + caption : ''}`;
        } else if (msg.messageType === 'video' || msg.message?.videoMessage) {
            content = `üé• [Video]`;
        } else if (msg.messageType === 'audio' || msg.message?.audioMessage) {
            content = `üéµ [Audio]`;
        } else if (msg.messageType === 'document' || msg.message?.documentMessage) {
            content = `üìÑ [Document]`;
        } else if (!content) {
            content = '[Message]';
        }

        // Time - robust parsing
        let timestamp = msg.timestamp || msg.messageTimestamp;
        if (typeof timestamp === 'number' && timestamp < 10000000000) timestamp *= 1000;
        // Handle if timestamp is missing or invalid
        let time = '';
        try {
            const date = timestamp ? new Date(timestamp) : new Date();
            if (!isNaN(date.getTime())) {
                time = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }
        } catch (e) { console.error('Date error', e); }
        
        // Agent info - show prominently for outgoing messages so boss can see who replied
        let agentHeader = '';
        let agentBadge = '';
        
        if (isOutgoing) {
            if (msg.isAiGenerated) {
                agentHeader = '<div class="message-sender ai">ü§ñ AI Assistant</div>';
            } else if (msg.agentName) {
                // Use provided agent name
                agentHeader = `<div class="message-sender agent">üë§ ${msg.agentName}</div>`;
            } else if (msg._tempId) {
                // Sent by current user (temp)
                agentHeader = `<div class="message-sender agent">üë§ ${currentAgentName || 'You'}</div>`;
            } else {
                // Fallback for outgoing without agent name
                agentHeader = `<div class="message-sender agent">üë§ ${currentAgentName || 'You'}</div>`;
            }
        } else {
            // Incoming - show sender name
            if (msg.senderName) {
                agentHeader = `<div class="message-sender customer">üì± ${msg.senderName}</div>`;
            }
        }
        
        // Badge in meta for AI
        if (msg.isAiGenerated) agentBadge = '<span class="message-agent">ü§ñ</span>';

        div.innerHTML = `
            ${agentHeader}
            ${content}
            <div class="message-meta">
                ${agentBadge}
                <span>${time}</span>
            </div>
        `;

        // Add temp-id for tracking temp messages
        if (msg._tempId) {
            div.setAttribute('data-temp-id', msg._tempId);
            // Store content for deduplication
            div.setAttribute('data-content-hash', btoa(encodeURIComponent(content)).substring(0, 20));
        }

        container.appendChild(div);
    }

    function handleNewMessage(data) {
        if (!data.data?.messages?.length) return;
        
        data.data.messages.forEach(msg => {
            const chatId = msg.key?.remoteJid;
            if (currentChat && chatId === currentChat.chatId) {
                // Deduplication logic for outgoing messages
                const isOutgoing = msg.key?.fromMe;
                if (isOutgoing) {
                    // Look for matching temp message by content
                    let content = '';
                    if (msg.message?.conversation) content = msg.message.conversation;
                    else if (msg.message?.extendedTextMessage?.text) content = msg.message.extendedTextMessage.text;
                    
                    if (content) {
                        const hash = btoa(encodeURIComponent(content)).substring(0, 20);
                        // Find temp message with same content hash (approximate match)
                        const tempEl = document.querySelector(`[data-content-hash="${hash}"]`);
                        if (tempEl) {
                            console.log('Replacing temp message with real one');
                            tempEl.remove();
                        }
                    }
                }
                
                appendMessageToView(msg);
                const container = document.getElementById('messages-container');
                container.scrollTop = container.scrollHeight;
            }
        });
        
        // Refresh chat list to update preview
        loadChats();
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !currentDeviceId || !currentChat) return;

        input.value = '';

        const device = devices.find(d => d.id == currentDeviceId);
        if (!device) return;

        // Add temp message immediately for instant feedback
        const tempId = 'temp-' + Date.now();
        const tempMsg = {
            _tempId: tempId,
            content: text,
            direction: 'outgoing',
            timestamp: new Date().toISOString(),
            agentName: currentAgentName // Use configured name
        };
        appendMessageToView(tempMsg);
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;

        try {
            const res = await fetch(`${API_URL}/api/whatsapp/send`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-Token': API_TOKEN
                },
                body: JSON.stringify({
                    sessionId: device.sessionId,
                    recipient: currentChat.chatId,
                    message: text,
                    agentId: currentAgentId,
                    agentName: currentAgentName
                })
            });

            const data = await res.json();
            if (!data.success) {
                // Remove temp message on failure
                const tempEl = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (tempEl) tempEl.remove();
                alert('Failed to send message');
            }
            // Don't append again - WebSocket will broadcast (and dedupe logic handles it)
        } catch (e) {
            // Remove temp message on error
            const tempEl = document.querySelector(`[data-temp-id="${tempId}"]`);
            if (tempEl) tempEl.remove();
            alert('Failed to send message');
        }
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    // Info Panel Functions
    function toggleInfoPanel() {
        document.getElementById('info-panel').classList.toggle('show');
    }

    function updateInfoPanel() {
        if (!currentChat) return;
        
        document.getElementById('ai-toggle').classList.toggle('active', currentChat.aiEnabled !== false);
        document.getElementById('human-toggle').classList.toggle('active', currentChat.humanTakeover === true);
        document.getElementById('status-select').value = currentChat.status || 'open';
        document.getElementById('priority-select').value = currentChat.priority || 'normal';
        document.getElementById('assigned-agent').textContent = currentChat.assignedAgentName || 'Unassigned';
        document.getElementById('notes-input').value = currentChat.notes || '';
        
        // Labels
        renderLabels();
    }

    function renderLabels() {
        const container = document.getElementById('labels-container');
        container.innerHTML = '';
        const labels = currentChat?.labels || [];
        labels.forEach(label => {
            const tag = document.createElement('span');
            tag.className = 'label-tag active';
            tag.innerHTML = `${label} <span class="remove" onclick="removeLabel('${label}')">√ó</span>`;
            container.appendChild(tag);
        });
    }

    function updateTakeoverButton() {
        const btn = document.getElementById('takeover-btn');
        if (currentChat?.humanTakeover) {
            btn.className = 'btn btn-danger';
            btn.innerHTML = 'üë§ Human Mode';
        } else {
            btn.className = 'btn btn-primary';
            btn.innerHTML = 'ü§ñ AI Active';
        }
    }

    async function toggleTakeover() {
        if (!currentChat) return;
        
        const isHuman = currentChat.humanTakeover;
        const endpoint = isHuman ? 'release' : 'takeover';
        
        try {
            const encodedChatId = encodeURIComponent(currentChat.chatId);
            await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats/${encodedChatId}/${endpoint}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-Token': API_TOKEN
                },
                body: JSON.stringify({ agentId: 'demo-agent', agentName: 'Demo Agent' })
            });
            
            currentChat.humanTakeover = !isHuman;
            updateTakeoverButton();
            updateInfoPanel();
            loadChats();
        } catch (e) {
            console.error('Failed to toggle takeover:', e);
        }
    }

    function toggleAI() {
        if (!currentChat) return;
        currentChat.aiEnabled = !currentChat.aiEnabled;
        document.getElementById('ai-toggle').classList.toggle('active', currentChat.aiEnabled);
        updateChatSettings();
    }

    function toggleHumanTakeover() {
        toggleTakeover();
    }

    async function updateChatSettings() {
        if (!currentChat) return;
        
        try {
            const encodedChatId = encodeURIComponent(currentChat.chatId);
            await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats/${encodedChatId}/settings`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-Token': API_TOKEN
                },
                body: JSON.stringify({
                    aiEnabled: currentChat.aiEnabled,
                    status: document.getElementById('status-select').value,
                    priority: document.getElementById('priority-select').value,
                    labels: currentChat.labels || []
                })
            });
            
            currentChat.status = document.getElementById('status-select').value;
            currentChat.priority = document.getElementById('priority-select').value;
            loadChats();
        } catch (e) {
            console.error('Failed to update settings:', e);
        }
    }

    async function updateNotes() {
        if (!currentChat) return;
        currentChat.notes = document.getElementById('notes-input').value;
        
        try {
            const encodedChatId = encodeURIComponent(currentChat.chatId);
            await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats/${encodedChatId}/settings`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-Token': API_TOKEN
                },
                body: JSON.stringify({ notes: currentChat.notes })
            });
        } catch (e) {
            console.error('Failed to update notes:', e);
        }
    }

    function handleAddLabel(e) {
        if (e.key !== 'Enter') return;
        const input = document.getElementById('add-label');
        const label = input.value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!label || !currentChat) return;
        
        currentChat.labels = currentChat.labels || [];
        if (!currentChat.labels.includes(label)) {
            currentChat.labels.push(label);
            renderLabels();
            updateChatSettings();
        }
        input.value = '';
    }

    function removeLabel(label) {
        if (!currentChat) return;
        currentChat.labels = (currentChat.labels || []).filter(l => l !== label);
        renderLabels();
        updateChatSettings();
    }

    async function assignToMe() {
        if (!currentChat) return;
        
        try {
            const encodedChatId = encodeURIComponent(currentChat.chatId);
            await fetch(`${API_URL}/api/whatsapp/devices/${currentDeviceId}/chats/${encodedChatId}/settings`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-Token': API_TOKEN
                },
                body: JSON.stringify({ 
                    assignedAgentId: 'demo-agent',
                    assignedAgentName: 'Demo Agent'
                })
            });
            
            currentChat.assignedAgentId = 'demo-agent';
            currentChat.assignedAgentName = 'Demo Agent';
            document.getElementById('assigned-agent').textContent = 'Demo Agent';
            loadChats();
        } catch (e) {
            console.error('Failed to assign:', e);
        }
    }

    function showSidebar() {
        document.getElementById('sidebar').classList.remove('hidden');
    }

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.onclick = function() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            // Filter logic would go here
        };
    });
    </script>
</body>
</html>
