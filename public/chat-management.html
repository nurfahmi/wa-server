<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Management - WhatsApp API</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      .chat-card {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
      }
      .chat-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-left-color: #0d6efd;
      }
      .chat-card.ai-enabled {
        border-left-color: #198754;
      }
      .chat-card.ai-disabled {
        border-left-color: #dc3545;
      }
      .chat-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(45deg, #0d6efd, #6610f2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
      }
      .status-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
      }
      .last-message {
        font-size: 0.85rem;
        color: #6c757d;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .chat-settings-panel {
        max-height: 80vh;
        overflow-y: auto;
      }
      .settings-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .customer-segment {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      .segment-new {
        background: #cce7ff;
        color: #004085;
      }
      .segment-returning {
        background: #d4edda;
        color: #155724;
      }
      .segment-vip {
        background: #fff3cd;
        color: #856404;
      }
      .segment-inactive {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">
            <i class="bi bi-chat-dots text-primary"></i>
            Chat Management
          </h1>
          <p class="text-muted mb-0">
            Manage individual chat settings and AI configuration
          </p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" id="refreshChats">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <a href="index.html" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>

      <!-- Device Selection & Stats -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body py-2">
              <h6 class="card-title mb-2">
                <i class="bi bi-phone"></i> Device
              </h6>
              <select class="form-select form-select-sm" id="deviceSelect">
                <option value="">Choose a device...</option>
              </select>
              <div id="deviceInfo" class="mt-1" style="display: none">
                <small class="text-muted">
                  <span id="deviceAlias"></span> |
                  <span id="deviceSession"></span>
                </small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body py-2">
              <h6 class="card-title mb-2">
                <i class="bi bi-bar-chart"></i> Stats
              </h6>
              <div class="row text-center">
                <div class="col">
                  <div class="h6 text-primary mb-0" id="totalChats">0</div>
                  <small class="text-muted">Total</small>
                </div>
                <div class="col">
                  <div class="h6 text-success mb-0" id="aiEnabledChats">0</div>
                  <small class="text-muted">AI Auto-Reply</small>
                </div>
                <div class="col">
                  <div class="h6 text-secondary mb-0" id="autoReplyChats">
                    0
                  </div>
                  <small class="text-muted">Manual</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="row">
        <!-- Chat List -->
        <div class="col-md-8">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0"><i class="bi bi-list"></i> Chat List</h5>
              <div class="d-flex gap-2">
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="searchChats"
                  placeholder="Search chats..."
                  style="width: 200px"
                />
                <select
                  class="form-select form-select-sm"
                  id="filterStatus"
                  style="width: 150px"
                >
                  <option value="">All Chats</option>
                  <option value="ai-auto-reply">AI Auto-Reply</option>
                  <option value="manual">Manual</option>
                </select>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="chatsList">
                <div class="text-center p-4 text-muted">
                  <i class="bi bi-chat-dots display-4"></i>
                  <p class="mt-2">Select a device to view chats</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Settings Panel -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-gear"></i> Chat Settings</h5>
            </div>
            <div class="card-body chat-settings-panel">
              <div id="chatSettingsContent">
                <div class="text-center text-muted" id="noSelectionMessage">
                  <i class="bi bi-gear display-4"></i>
                  <p class="mt-2">Select a chat to configure settings</p>
                  <small class="text-info"
                    >API is working! Devices and chats are loading...</small
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Settings Modal -->
    <div class="modal fade" id="chatSettingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-gear"></i> Advanced Chat Settings
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="advancedChatSettings">
              <!-- Content will be populated by JavaScript -->
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveChatSettings">
              <i class="bi bi-save"></i> Save Settings
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let selectedDeviceId = null;
      let selectedChatData = null;
      let allChats = [];

      // API Configuration
      const API_BASE = window.location.origin;
      const API_TOKEN = "test123"; // Replace with actual token management

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        loadDevices();
        setupEventListeners();
      });

      function setupEventListeners() {
        document
          .getElementById("deviceSelect")
          .addEventListener("change", handleDeviceSelection);
        document
          .getElementById("refreshChats")
          .addEventListener("click", refreshChats);
        document
          .getElementById("searchChats")
          .addEventListener("input", filterChats);
        document
          .getElementById("filterStatus")
          .addEventListener("change", filterChats);
        document
          .getElementById("saveChatSettings")
          .addEventListener("click", saveChatSettings);

        // Add event delegation for chat cards (since they're dynamically generated)
        document
          .getElementById("chatsList")
          .addEventListener("click", function (e) {
            console.log("Chat list clicked", e.target);
            const chatCard = e.target.closest(".chat-card");
            console.log("Found chat card:", chatCard);
            if (chatCard && chatCard.dataset.chatId) {
              console.log("Chat ID:", chatCard.dataset.chatId);
              selectChat(parseInt(chatCard.dataset.chatId));
            }
          });

        // Add event delegation for retry button (since it's dynamically generated)
        document
          .getElementById("chatsList")
          .addEventListener("click", function (e) {
            if (e.target.closest("#retryLoadChats")) {
              loadChats();
            }
          });

        // Add event delegation for chat settings buttons (since they're dynamically generated)
        document
          .getElementById("chatSettingsContent")
          .addEventListener("click", function (e) {
            if (e.target.closest("#viewConversationBtn")) {
              viewConversation();
            } else if (e.target.closest("#saveChatSettingsBtn")) {
              saveChatSettings();
            }
          });

        // Add event delegation for customer segment dropdown
        document
          .getElementById("chatSettingsContent")
          .addEventListener("change", function (e) {
            if (e.target.id === "chatCustomerSegmentSelect") {
              const customInput = document.getElementById(
                "chatCustomerSegmentCustom"
              );
              if (e.target.value === "custom") {
                customInput.style.display = "block";
                customInput.focus();
              } else {
                customInput.style.display = "none";
                customInput.value = "";
              }
            }
          });
      }

      // Load available devices
      async function loadDevices() {
        try {
          const response = await fetch(`${API_BASE}/api/whatsapp/sessions`, {
            headers: {
              "X-API-Token": API_TOKEN,
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          const deviceSelect = document.getElementById("deviceSelect");

          deviceSelect.innerHTML =
            '<option value="">Choose a device...</option>';

          if (data.sessions && data.sessions.length > 0) {
            data.sessions.forEach((session) => {
              const option = document.createElement("option");
              option.value = session.id;
              option.textContent = `${session.alias || session.sessionId} (${
                session.status
              })`;
              deviceSelect.appendChild(option);
            });
          } else {
            deviceSelect.innerHTML +=
              '<option value="" disabled>No devices found</option>';
          }
        } catch (error) {
          console.error("Error loading devices:", error);
          const deviceSelect = document.getElementById("deviceSelect");
          deviceSelect.innerHTML = `
            <option value="">Choose a device...</option>
            <option value="" disabled>Error loading devices</option>
          `;
        }
      }

      // Handle device selection
      async function handleDeviceSelection(e) {
        selectedDeviceId = e.target.value;
        if (selectedDeviceId) {
          try {
            // Fetch device details to show accurate information
            const response = await fetch(
              `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}`,
              {
                headers: {
                  "X-API-Token": API_TOKEN,
                  Accept: "application/json",
                },
              }
            );

            if (response.ok) {
              const data = await response.json();
              const device = data.device;

              document.getElementById("deviceInfo").style.display = "block";
              document.getElementById("deviceAlias").textContent =
                device.alias || device.sessionId || "Unknown Device";
              document.getElementById("deviceSession").textContent =
                device.sessionId || `session_${selectedDeviceId}`;
            } else {
              // Fallback to basic info if device details fetch fails
              document.getElementById("deviceInfo").style.display = "block";
              document.getElementById("deviceAlias").textContent =
                e.target.selectedOptions[0].text;
              document.getElementById(
                "deviceSession"
              ).textContent = `session_${selectedDeviceId}`;
            }
          } catch (error) {
            console.error("Error fetching device details:", error);
            // Fallback to basic info
            document.getElementById("deviceInfo").style.display = "block";
            document.getElementById("deviceAlias").textContent =
              e.target.selectedOptions[0].text;
            document.getElementById(
              "deviceSession"
            ).textContent = `session_${selectedDeviceId}`;
          }

          loadChats();
        } else {
          document.getElementById("deviceInfo").style.display = "none";
          clearChatsList();
        }
      }

      // Load chats for selected device
      async function loadChats() {
        if (!selectedDeviceId) return;

        try {
          showLoading("chatsList");

          // Try to load chats from chat settings API first
          let response;
          try {
            response = await fetch(
              `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}/chat-settings`,
              {
                headers: {
                  "X-API-Token": API_TOKEN,
                  Accept: "application/json",
                },
              }
            );
          } catch (fetchError) {
            console.log("Chat settings API not available, trying chats API...");

            // Fallback to regular chats API
            response = await fetch(
              `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}/chats`,
              {
                headers: {
                  "X-API-Token": API_TOKEN,
                  Accept: "application/json",
                },
              }
            );
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          // Handle both chat settings and regular chats response formats
          let chats = [];
          if (data.chats) {
            chats = data.chats;
          } else if (data.success && data.chats) {
            chats = data.chats;
          } else if (Array.isArray(data)) {
            chats = data;
          }

          // Convert API data to our expected format
          allChats = chats.map((chat) => ({
            id: chat.id || Math.random(),
            phoneNumber:
              chat.phoneNumber || chat.jid?.split("@")[0] || "Unknown",
            contactName:
              chat.contactName || chat.whatsappName || chat.name || null,
            chatId:
              chat.chatId || chat.jid || `${chat.phoneNumber}@s.whatsapp.net`,
            aiEnabled: chat.aiEnabled,
            lastMessageContent: chat.lastMessageContent || "No recent messages",
            lastMessageDirection: chat.lastMessageDirection || "incoming",
            lastActivity: chat.lastMessageTimestamp
              ? new Date(chat.lastMessageTimestamp)
              : chat.lastSeen
              ? new Date(chat.lastSeen)
              : new Date(),
            totalIncomingMessages: chat.totalIncomingMessages || 0,
            totalOutgoingMessages: chat.totalOutgoingMessages || 0,
            customerSegment: chat.customerSegment || "regular",
            leadScore: chat.leadScore || 0,
            totalSpent: parseFloat(chat.totalSpent) || 0,

            notes: chat.notes || null,
          }));

          console.log("Loaded chats:", allChats.length, allChats);
          updateChatStatistics(allChats);
          renderChatsList(allChats);
        } catch (error) {
          console.error("Error loading chats:", error);
          document.getElementById("chatsList").innerHTML = `
            <div class="text-center p-4 text-danger">
              <i class="bi bi-exclamation-triangle display-4"></i>
              <p class="mt-2">Error loading chats: ${error.message}</p>
              <p class="small text-muted">Device ID: ${selectedDeviceId}</p>
              <button class="btn btn-outline-primary" id="retryLoadChats">
                <i class="bi bi-arrow-clockwise"></i> Retry
              </button>
            </div>
          `;
        }
      }

      // Update chat statistics
      function updateChatStatistics(chats) {
        const stats = {
          total: chats.length,
          aiAutoReply: chats.filter((chat) => chat.aiEnabled === true).length,
          manual: chats.filter((chat) => chat.aiEnabled !== true).length,
        };

        document.getElementById("totalChats").textContent = stats.total;
        document.getElementById("aiEnabledChats").textContent =
          stats.aiAutoReply;
        document.getElementById("autoReplyChats").textContent = stats.manual;
      }

      // Render chats list
      function renderChatsList(chats) {
        const container = document.getElementById("chatsList");

        if (chats.length === 0) {
          container.innerHTML = `
            <div class="text-center p-4 text-muted">
              <i class="bi bi-chat-dots display-4"></i>
              <p class="mt-2">No chats found</p>
            </div>
          `;
          return;
        }

        const chatsHtml = chats
          .map(
            (chat) => `
          <div class="chat-card p-2 border-bottom ${getChatCardClass(chat)}" 
               data-chat-id="${chat.id}"
               style="cursor: pointer;">
            <div class="d-flex align-items-center">
              <div class="chat-avatar me-2" style="width: 35px; height: 35px; font-size: 12px;">
                ${getContactInitials(chat.contactName || chat.phoneNumber)}
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div style="flex: 1; min-width: 0;">
                    <div class="mb-1">
                      <strong style="font-size: 0.9rem;">${
                        chat.contactName || chat.phoneNumber
                      }</strong>
                      ${getStatusBadges(chat)}
                    </div>
                    <div class="last-message text-muted" style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${
                      chat.lastMessageContent || "No messages"
                    }">
                      ${chat.lastMessageContent || "No messages"}
                    </div>
                  </div>
                  <div class="text-end ms-2">
                    <small class="text-muted" style="font-size: 0.7rem;">
                      ${formatTimeAgo(chat.lastActivity)}
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = chatsHtml;
      }

      // Get chat card CSS class based on AI status
      function getChatCardClass(chat) {
        if (chat.aiEnabled === true) return "ai-enabled";
        if (chat.aiEnabled === false) return "ai-disabled";
        return "";
      }

      // Get contact initials for avatar
      function getContactInitials(name) {
        if (!name) return "?";
        const parts = name.split(" ");
        if (parts.length >= 2) {
          return parts[0][0].toUpperCase() + parts[1][0].toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
      }

      // Get status badges for chat
      function getStatusBadges(chat) {
        let badges = [];

        if (chat.aiEnabled === true) {
          badges.push(
            '<span class="badge bg-success status-badge">AI Auto-Reply</span>'
          );
        } else {
          badges.push(
            '<span class="badge bg-secondary status-badge">Manual</span>'
          );
        }

        return badges.join(" ");
      }

      // Format time ago
      function formatTimeAgo(date) {
        if (!date) return "Never";

        const now = new Date();
        const diff = now - new Date(date);
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        return "Just now";
      }

      // Select chat and show settings
      function selectChat(chatId) {
        console.log("Selecting chat:", chatId);
        selectedChatData = allChats.find((chat) => chat.id == chatId);
        console.log("Found chat data:", selectedChatData);

        if (selectedChatData) {
          renderChatSettings(selectedChatData);

          // Highlight selected chat
          document.querySelectorAll(".chat-card").forEach((card) => {
            card.classList.remove("bg-light", "border-primary");
          });

          // Find and highlight the selected chat card
          const selectedCard = document.querySelector(
            `[data-chat-id="${chatId}"]`
          );
          if (selectedCard) {
            selectedCard.classList.add("bg-light", "border-primary");
            console.log("Highlighted chat card");
          }
        } else {
          console.log("Chat not found in allChats array");
        }
      }

      // Render chat settings panel
      function renderChatSettings(chat) {
        console.log("Rendering settings for chat:", chat);
        const container = document.getElementById("chatSettingsContent");

        container.innerHTML = `
          <div class="text-center mb-3">
            <div class="chat-avatar mx-auto mb-2" style="width: 60px; height: 60px;">
              ${getContactInitials(chat.contactName || chat.phoneNumber)}
            </div>
            <h6>${chat.contactName || "Unknown Contact"}</h6>
            <small class="text-muted">${chat.phoneNumber}</small>
          </div>

          <!-- AI Settings -->
          <div class="settings-section">
            <h6><i class="bi bi-robot"></i> AI Configuration</h6>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="chatAiAutoReply" 
                     ${chat.aiEnabled === true ? "checked" : ""}>
              <label class="form-check-label" for="chatAiAutoReply">
                <strong>AI Auto-Reply</strong>
              </label>
              <small class="form-text text-muted">When ON: AI will automatically respond to messages in this chat</small>
            </div>
          </div>

          <!-- Customer Information -->
          <div class="settings-section">
            <h6><i class="bi bi-person"></i> Customer Info</h6>
            <div class="mb-2">
              <label class="form-label small">Contact Name</label>
              <input type="text" class="form-control form-control-sm" id="chatContactName" 
                     value="${
                       chat.contactName || ""
                     }" placeholder="Enter contact name">
            </div>
            <div class="mb-3">
              <label class="form-label small">Customer Segment</label>
              <div class="input-group input-group-sm">
                <select class="form-select" id="chatCustomerSegmentSelect">
                  <option value="">Choose default...</option>
                  <option value="new" ${
                    chat.customerSegment === "new" ? "selected" : ""
                  }>New Customer</option>
                  <option value="returning" ${
                    chat.customerSegment === "returning" ? "selected" : ""
                  }>Returning Customer</option>
                  <option value="vip" ${
                    chat.customerSegment === "vip" ? "selected" : ""
                  }>VIP Customer</option>
                  <option value="lead" ${
                    chat.customerSegment === "lead" ? "selected" : ""
                  }>Lead</option>
                  <option value="custom">Custom Segment...</option>
                </select>
              </div>
              <input type="text" class="form-control form-control-sm mt-1" id="chatCustomerSegmentCustom" 
                     placeholder="e.g., Premium Product A, Campaign 2024, B2B Client..." 
                     value="${
                       chat.customerSegment &&
                       !["new", "returning", "vip", "lead"].includes(
                         chat.customerSegment
                       )
                         ? chat.customerSegment
                         : ""
                     }"
                     style="display: ${
                       chat.customerSegment &&
                       !["new", "returning", "vip", "lead"].includes(
                         chat.customerSegment
                       )
                         ? "block"
                         : "none"
                     }">
              <small class="text-muted">Use custom segments for campaigns, products, or specific business needs</small>
            </div>
          </div>

          <!-- Notes -->
          <div class="settings-section">
            <h6><i class="bi bi-chat-text"></i> Notes</h6>
            <div class="mb-3">
              <label class="form-label small">Internal Notes</label>
              <textarea class="form-control form-control-sm" rows="3" id="chatNotes" 
                        placeholder="Remember something about this customer... e.g., preferences, special requests, follow-up dates...">${
                          chat.notes || ""
                        }</textarea>
              <small class="text-muted">Private notes only visible to you - helps remember important details about this customer</small>
            </div>
          </div>

          <!-- Chat Statistics -->
          <div class="settings-section">
            <h6><i class="bi bi-bar-chart"></i> Statistics</h6>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-success fw-bold">${
                  chat.totalIncomingMessages
                }</div>
                <small class="text-muted">Incoming</small>
              </div>
              <div class="col-6">
                <div class="text-primary fw-bold">${
                  chat.totalOutgoingMessages
                }</div>
                <small class="text-muted">Outgoing</small>
              </div>
            </div>
            <div class="mt-2 text-center">
              <small class="text-muted">
                Last message: ${formatTimeAgo(chat.lastActivity)}
              </small>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <button class="btn btn-info btn-sm" id="viewConversationBtn">
              <i class="bi bi-chat-dots"></i> View Conversation
            </button>
            <button class="btn btn-success btn-sm" id="saveChatSettingsBtn">
              <i class="bi bi-save"></i> Save Settings
            </button>
          </div>
        `;
      }

      // Save chat settings
      async function saveChatSettings() {
        if (!selectedChatData) return;

        try {
          // Get customer segment value (either from dropdown or custom input)
          const segmentSelect = document.getElementById(
            "chatCustomerSegmentSelect"
          )?.value;
          const segmentCustom = document.getElementById(
            "chatCustomerSegmentCustom"
          )?.value;
          const customerSegment =
            segmentSelect === "custom" ? segmentCustom : segmentSelect;

          const settings = {
            aiEnabled: document.getElementById("chatAiAutoReply")?.checked,
            contactName:
              document.getElementById("chatContactName")?.value || null,
            customerSegment: customerSegment || null,
            notes: document.getElementById("chatNotes")?.value || null,
          };

          // API call to save settings
          const response = await fetch(
            `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}/chat-settings/${selectedChatData.phoneNumber}`,
            {
              method: "PUT",
              headers: {
                "X-API-Token": API_TOKEN,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(settings),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          // Update local data
          Object.assign(selectedChatData, settings);

          // Refresh display
          renderChatsList(allChats);
          renderChatSettings(selectedChatData);
          updateChatStatistics(allChats);

          // Show success message
          console.log("âœ… Chat settings saved successfully!");

          // Simple visual feedback
          const saveBtn = document.getElementById("saveChatSettingsBtn");
          const originalText = saveBtn.innerHTML;
          saveBtn.innerHTML = '<i class="bi bi-check"></i> Saved!';
          saveBtn.classList.remove("btn-success");
          saveBtn.classList.add("btn-outline-success");

          setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.classList.remove("btn-outline-success");
            saveBtn.classList.add("btn-success");
          }, 2000);
        } catch (error) {
          console.error("Error saving chat settings:", error);
          alert("Error saving settings: " + error.message);
        }
      }

      // Filter chats
      function filterChats() {
        const searchTerm = document
          .getElementById("searchChats")
          .value.toLowerCase();
        const statusFilter = document.getElementById("filterStatus").value;

        let filtered = allChats.filter((chat) => {
          // Search filter
          const matchesSearch =
            !searchTerm ||
            (chat.contactName &&
              chat.contactName.toLowerCase().includes(searchTerm)) ||
            chat.phoneNumber.includes(searchTerm) ||
            (chat.lastMessageContent &&
              chat.lastMessageContent.toLowerCase().includes(searchTerm));

          // Status filter
          let matchesStatus = true;
          if (statusFilter === "ai-auto-reply")
            matchesStatus = chat.aiEnabled === true;
          else if (statusFilter === "manual")
            matchesStatus = chat.aiEnabled !== true;

          return matchesSearch && matchesStatus;
        });

        renderChatsList(filtered);
      }

      // Refresh chats
      function refreshChats() {
        if (selectedDeviceId) {
          loadChats();
          showNotification("Chats refreshed", "info");
        }
      }

      // Clear chats list
      function clearChatsList() {
        document.getElementById("chatsList").innerHTML = `
          <div class="text-center p-4 text-muted">
            <i class="bi bi-chat-dots display-4"></i>
            <p class="mt-2">Select a device to view chats</p>
          </div>
        `;
        document.getElementById("chatSettingsContent").innerHTML = `
          <div class="text-center text-muted">
            <i class="bi bi-gear display-4"></i>
            <p class="mt-2">Select a chat to configure settings</p>
          </div>
        `;
      }

      // Show loading spinner
      function showLoading(elementId) {
        document.getElementById(elementId).innerHTML = `
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading chats...</p>
          </div>
        `;
      }

      // Show notification
      function showNotification(message, type = "info") {
        const alertClass =
          type === "error"
            ? "alert-danger"
            : type === "success"
            ? "alert-success"
            : "alert-info";

        const notification = document.createElement("div");
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }

      // Utility function for API calls (placeholder)
      async function fetchAPI(endpoint, method = "GET", data = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-API-Token": API_TOKEN,
          },
        };

        if (data && method !== "GET") {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);

        if (!response.ok) {
          throw new Error(
            `API Error: ${response.status} ${response.statusText}`
          );
        }

        return response.json();
      }

      // Conversation functions
      let conversationModal;
      let currentConversationOffset = 0;

      async function viewConversation() {
        if (!selectedChatData || !selectedDeviceId) return;

        try {
          // Show modal
          if (!conversationModal) {
            conversationModal = new bootstrap.Modal(
              document.getElementById("conversationModal")
            );
          }
          conversationModal.show();

          // Update modal title and info
          document.getElementById("conversationContact").textContent =
            selectedChatData.contactName || "Unknown Contact";
          document.getElementById("conversationPhone").textContent =
            selectedChatData.phoneNumber;

          // Load conversation
          await loadConversationHistory();

          // Load stats
          await loadConversationStats();
        } catch (error) {
          console.error("Error viewing conversation:", error);
          showNotification(
            "Error loading conversation: " + error.message,
            "error"
          );
        }
      }

      async function loadConversationHistory(offset = 0) {
        try {
          const response = await fetch(
            `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}/chat-settings/${selectedChatData.phoneNumber}/conversation?limit=50&offset=${offset}`,
            {
              headers: {
                "X-API-Token": API_TOKEN,
                Accept: "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          const container = document.getElementById("conversationContainer");

          if (offset === 0) {
            // First load - clear container
            if (data.conversation.length === 0) {
              container.innerHTML = `
                <div class="text-center text-muted">
                  <i class="bi bi-chat-dots-fill display-4"></i>
                  <p>No conversation history found</p>
                  <small>Messages will appear here when the chat becomes active</small>
                </div>
              `;
            } else {
              container.innerHTML = "";
            }
          }

          // Add messages
          data.conversation.forEach((msg) => {
            const messageEl = document.createElement("div");
            messageEl.className = `d-flex mb-3 ${
              msg.role === "assistant" || msg.direction === "outgoing"
                ? "justify-content-end"
                : ""
            }`;

            const isOutgoing =
              msg.role === "assistant" || msg.direction === "outgoing";
            const bgClass = isOutgoing ? "bg-primary text-white" : "bg-light";
            const alignClass = isOutgoing ? "text-end" : "";

            messageEl.innerHTML = `
              <div class="message-bubble ${bgClass} p-2 rounded max-width-75 ${alignClass}">
                <div class="message-content">${escapeHtml(msg.content)}</div>
                <div class="message-time">
                  <small class="opacity-75">
                    ${new Date(msg.timestamp).toLocaleString()} 
                    <span class="badge badge-sm ${
                      isOutgoing ? "bg-primary-subtle" : "bg-secondary"
                    }">${msg.source}</span>
                  </small>
                </div>
              </div>
            `;

            if (offset === 0) {
              container.appendChild(messageEl);
            } else {
              container.insertBefore(messageEl, container.firstChild);
            }
          });

          // Show/hide load more button
          const loadMoreBtn = document.getElementById("loadMoreConversation");
          if (data.pagination.hasMore) {
            loadMoreBtn.style.display = "block";
            currentConversationOffset = offset + data.conversation.length;
          } else {
            loadMoreBtn.style.display = "none";
          }

          // Scroll to bottom on first load
          if (offset === 0 && data.conversation.length > 0) {
            container.scrollTop = container.scrollHeight;
          }
        } catch (error) {
          console.error("Error loading conversation:", error);
          document.getElementById("conversationContainer").innerHTML = `
            <div class="text-center text-danger">
              <i class="bi bi-exclamation-triangle display-4"></i>
              <p>Error loading conversation</p>
              <small>${error.message}</small>
            </div>
          `;
        }
      }

      async function loadConversationStats() {
        try {
          const response = await fetch(
            `${API_BASE}/api/whatsapp/devices/${selectedDeviceId}/chat-settings/${selectedChatData.phoneNumber}/stats`,
            {
              headers: {
                "X-API-Token": API_TOKEN,
                Accept: "application/json",
              },
            }
          );

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          const stats = data.stats;

          document.getElementById(
            "conversationStats"
          ).textContent = `${stats.totalMessages} messages (${stats.userMessages} user, ${stats.aiMessages} AI)`;
        } catch (error) {
          console.error("Error loading stats:", error);
          document.getElementById("conversationStats").textContent =
            "Stats unavailable";
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>

    <!-- Conversation Modal -->
    <div class="modal fade" id="conversationModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-chat-dots"></i> Conversation History
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Chat Info -->
            <div class="row mb-3">
              <div class="col-md-8">
                <strong id="conversationContact">Contact Name</strong><br />
                <small class="text-muted" id="conversationPhone"
                  >Phone Number</small
                >
              </div>
              <div class="col-md-4 text-end">
                <span class="badge bg-info" id="conversationStats"
                  >0 messages</span
                >
              </div>
            </div>

            <!-- Conversation Container -->
            <div
              class="conversation-container"
              id="conversationContainer"
              style="
                height: 400px;
                overflow-y: auto;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 15px;
                background: #f8f9fa;
              "
            >
              <div class="text-center text-muted">
                <i class="bi bi-chat-dots-fill display-4"></i>
                <p>Loading conversation...</p>
              </div>
            </div>

            <!-- Load More -->
            <div class="text-center mt-3">
              <button
                class="btn btn-outline-primary btn-sm"
                id="loadMoreConversation"
                style="display: none"
                onclick="loadConversationHistory(currentConversationOffset)"
              >
                <i class="bi bi-arrow-down-circle"></i> Load More Messages
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <style>
      .max-width-75 {
        max-width: 75%;
      }
      .message-bubble {
        word-wrap: break-word;
      }
      .conversation-container::-webkit-scrollbar {
        width: 6px;
      }
      .conversation-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .conversation-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }
      .conversation-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </body>
</html>
